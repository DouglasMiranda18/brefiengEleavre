<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TFIMPORTS — Moda Masculina Premium</title>
  <meta name="description" content="TFIMPORTS — Moda masculina premium inspirada no lifestyle Playboy. Exclusividade, atitude e sofisticação. Compre online: camisetas, calças, bermudas, cuecas premium e mais." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2712%27 fill=%27%230b1220%27/%3E%3Cpath d=%27M13 46c8-2 14-9 19-18 2-4 5-7 9-9 4-2 9-2 10 2s-2 10-7 13c-3 2-6 2-9 3-6 2-9 6-10 10-1 3-7 3-12-1z%27 fill=%27%2346d39a%27/%3E%3Ctext x=%2732%27 y=%2738%27 font-size=%2722%27 text-anchor=%27middle%27 fill=%27%23e5edf8%27 font-family=%27Georgia, serif%27%3ETF%3C/text%3E%3C/svg%3E" />
  
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com https://*.google.com;
    style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
    img-src 'self' data: https:;
    connect-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com https://firestore.googleapis.com https://viacep.com.br https://api.asaas.com https://www.asaas.com https://api.superfrete.com https://api.allorigins.win https://www.instagram.com;
    frame-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://accounts.google.com https://*.google.com;
    font-src 'self' data:;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
  " />
  
  <!-- Outros headers de segurança -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="unsafe-none" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @font-face {
      font-family: "InterVar";
      src: local("Inter");
    }
    :root{
      --ink:#0b1220; /* azul escuro profundo */
      --night:#070b12; /* quase preto */
      --accent:#1dd1a1; /* verde sofisticado */
      --accent-2:#18b68c;
      --ink-2:#101b33;
      --paper:#e5edf8;
    }
    html,body { background: radial-gradient(1200px 600px at 70% -10%, #0f1a33 0%, var(--night) 45%) fixed, var(--night); color: #e8f0ff; }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
    }
    .btn {
      transition: transform .15s ease, box-shadow .15s ease, background .2s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 28px rgba(0,0,0,.32); }
    
    /* Estilos para pagamento */
    .payment-method-btn {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .payment-method-btn:hover {
      border-color: rgba(29, 209, 161, 0.5);
      transform: translateY(-2px);
    }
    .payment-method-btn.selected {
      border-color: #1dd1a1;
      background: rgba(29, 209, 161, 0.1);
    }
    .payment-form {
      transition: all 0.3s ease;
    }
    .pulse {
      animation: pulse 2.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .tag {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #041313;
      font-weight: 700;
      letter-spacing: .02em;
    }
    .card-img {
      background: linear-gradient(140deg, #0f1a2e, #0a0f1f);
    }
    .star { color: #ffd166; }
    .badge { background: rgba(29, 209, 161, .12); color: var(--accent); border: 1px solid rgba(29,209,161,.35); }
    .nav-active { color: var(--accent); }
    .gradient-title {
      background: linear-gradient(90deg, #bcd5ff, #7fb7ff);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .cta-gradient {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #041313;
    }
    .shadow-soft { box-shadow: 0 20px 50px rgba(0,0,0,.35); }
    .ring-accent { box-shadow: inset 0 0 0 1px rgba(29,209,161,.4); }
    .grid-auto-fit { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 320px)); 
      gap: 1.5rem; 
      justify-content: center;
      justify-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    @media (max-width: 640px) {
      .grid-auto-fit { 
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
        gap: 1rem;
        max-width: none;
        margin: 0;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .grid-auto-fit::-webkit-scrollbar {
        display: none;
      }
      .grid-auto-fit::before,
      .grid-auto-fit::after {
        content: '';
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        background: linear-gradient(45deg, transparent, rgba(29, 209, 161, 0.3));
        border-radius: 50%;
        pointer-events: none;
        z-index: 10;
      }
      .grid-auto-fit::before {
        left: 10px;
        background: linear-gradient(45deg, transparent, rgba(29, 209, 161, 0.3));
      }
      .grid-auto-fit::after {
        right: 10px;
        background: linear-gradient(225deg, transparent, rgba(29, 209, 161, 0.3));
      }
    }
    .hidden-scroll::-webkit-scrollbar { display: none; }
    .hidden-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Corrigir scroll horizontal no mobile */
    body { overflow-x: hidden; }
    .panel { overflow-x: hidden; }
    
    /* Garantir que elementos não ultrapassem a largura da tela */
    * { max-width: 100%; }
    img { max-width: 100%; height: auto; }
    .qr {
      background: conic-gradient(from 90deg at 1px 1px, #000 90deg, #fff 0) 0 0/8px 8px;
      image-rendering: pixelated;
      border: 8px solid #fff;
    }
    .panel { display: none; }
    .panel.active { display: block; }
    .modal-mask { background: rgba(3,6,12,.6); backdrop-filter: blur(4px); }
    .hint { color: #9bb6da; }
    .pill { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.18) }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <!-- Módulos de segurança -->
  <script type="module" src="config.js"></script>
  <script type="module" src="security.js"></script>
  
  <!-- Módulos de integração -->
  <script type="module" src="api-config.js"></script>
  <script type="module" src="asaas.js"></script>
  <script type="module" src="order-manager.js"></script>
</head>
<body class="font-[InterVar] selection:bg-emerald-300 selection:text-black">
  <!-- Header -->
  <header class="sticky top-0 z-40 glass">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-2 sm:py-3 flex items-center justify-between">
      <div class="flex items-center gap-2 sm:gap-3">
        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center ring-accent overflow-hidden">
          <img src="1000048219.webp" alt="TFIMPORTS Logo" class="w-full h-full object-cover rounded-xl" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <svg width="24" height="24" class="sm:w-7 sm:h-7" viewBox="0 0 64 64" aria-hidden="true" style="display:none;">
            <rect width="64" height="64" rx="12" fill="#0b1220"/>
            <path d="M13 46c8-2 14-9 19-18 2-4 5-7 9-9 4-2 9-2 10 2s-2 10-7 13c-3 2-6 2-9 3-6 2-9 6-10 10-1 3-7 3-12-1z" fill="#1dd1a1"/>
          </svg>
        </div>
        <a href="#home" data-route class="hidden sm:block cursor-pointer hover:opacity-80 transition-opacity">
          <div class="text-lg sm:text-xl font-extrabold tracking-wide gradient-title">TFIMPORTS</div>
          <div class="text-xs uppercase tracking-widest text-slate-300">Exclusividade • Atitude • Sofisticação</div>
        </a>
        <a href="#home" data-route class="block sm:hidden cursor-pointer hover:opacity-80 transition-opacity">
          <div class="text-lg font-extrabold tracking-wide gradient-title">TFI</div>
        </a>
      </div>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#home" data-route class="hover:text-emerald-300">Home</a>
        <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
        <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
        <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
        <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
        <a href="#minha-conta" data-route id="navMinhaConta" class="ml-2 px-3 py-1 rounded-full pill hidden">Minha Conta</a>
        <a href="#admin" data-route id="navAdmin" class="ml-2 px-3 py-1 rounded-full badge hidden">Painel Admin</a>
      </nav>

      <div class="flex items-center gap-2 sm:gap-3">
        <button id="btnLogin" class="btn px-3 py-2 rounded-lg pill text-slate-200 hover:text-white text-sm sm:text-base">Entrar</button>
        
        <!-- Contador de Carrinho -->
        <a href="#carrinho" data-route id="miniCart" class="relative btn px-3 py-2 rounded-lg pill hover:text-white group">
          <svg class="w-5 h-5 sm:w-6 sm:h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l-1 12H6L5 9z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9v4m8-4v4"></path>
          </svg>
          <span id="cartCount" class="absolute -top-2 -right-2 bg-gradient-to-r from-emerald-400 to-emerald-500 text-black text-xs font-bold w-5 h-5 sm:w-6 sm:h-6 rounded-full grid place-items-center shadow-lg">0</span>
        </a>
        
        <button id="btnMenu" class="md:hidden btn px-3 py-2 rounded-lg pill">☰</button>
      </div>
    </div>
    <div id="mobileNav" class="md:hidden hidden glass border-t border-white/10">
      <div class="px-4 py-3 flex flex-col gap-3">
        <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
        <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
        <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
        <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
        <a href="#minha-conta" data-route id="navMinhaContaMobile" class="px-3 py-2 rounded-lg pill text-center hidden">Minha Conta</a>
        <a href="#admin" data-route id="navAdminMobile" class="px-3 py-2 rounded-lg badge text-center hidden">Painel Admin</a>
      </div>
    </div>
  </header>

  <!-- Botão Flutuante WhatsApp -->
  <a href="https://wa.me/5584986967770?text=Olá! Gostaria de saber mais sobre os produtos da TFIMPORTS" 
     target="_blank" 
     rel="noopener noreferrer"
     class="fixed right-4 bottom-4 z-50 bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110 group">
    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
    </svg>
    <div class="absolute right-16 top-1/2 transform -translate-y-1/2 bg-gray-800 text-white px-3 py-2 rounded-lg text-sm whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300">
      Fale conosco no WhatsApp
    </div>
  </a>

  <!-- Hero -->
  <section id="home" class="panel active">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 pt-10 pb-12">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <div class="inline-flex items-center gap-2 tag px-3 py-1 rounded-full mb-4">LIFESTYLE PLAYBOY</div>
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
            Moda masculina premium com presença, confiança e impacto.
          </h1>
          <p class="mt-4 text-slate-300">
            Peças que destacam atitude e sofisticação. Se vista como quem lidera.
          </p>
          <div class="mt-6 flex flex-wrap gap-4">
            <a href="#loja" data-route class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Comprar agora</a>
            <a href="#novidades" data-route class="btn px-5 py-3 rounded-xl pill text-slate-200 hover:text-white">Ver lançamentos</a>
          </div>
          <div class="mt-6 flex items-center gap-4 text-sm text-slate-400">
            <div class="flex items-center gap-2"><span class="star">★ ★ ★ ★ ★</span> <span id="feedbackCount">0 avaliações</span></div>
            <div class="hidden sm:block">•</div>
            <div>Envio rápido e rastreável</div>
          </div>
        </div>
        <div class="relative">
          <div class="glass shadow-soft rounded-3xl p-6 ring-accent">
            <div class="grid grid-cols-3 gap-3" id="featuredProductsPreview">
              <!-- Produtos da coleção destaque serão inseridos aqui dinamicamente -->
            </div>
              <div class="col-span-3 glass rounded-2xl p-4 flex items-center justify-between">
                <div>
                  <div class="text-sm text-slate-300">Coleção destaque</div>
                  <div class="text-lg font-bold" id="homeCollectionName">TFI Black Label</div>
                </div>
                <a href="#loja" data-route class="btn px-4 py-2 rounded-lg cta-gradient font-bold">Ver</a>
              </div>
            </div>
          </div>
          <div class="absolute -top-4 -right-4 tag px-3 py-1 rounded-full pulse">Novo</div>
        </div>
      </div>

      <!-- Faixa de categorias -->
      <div class="mt-6">
        <div id="categoryChips" class="flex flex-wrap gap-3 justify-center">
          <!-- chips dinamicos -->
        </div>
      </div>

      <!-- Destaques -->
      <div class="mt-4">
        <h2 class="text-2xl font-bold mb-6 text-center">Destaques</h2>
        <div class="relative">
          <div id="featuredGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 lg:gap-4"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Loja -->
  <section id="loja" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Filtros -->
        <aside class="md:w-64 glass rounded-2xl p-5 h-max">
          <h3 class="font-bold text-lg mb-3">Filtrar</h3>
          <div class="space-y-4">
            <div>
              <div class="text-sm text-slate-300 mb-2">Categoria</div>
              <select id="filterCategoria" class="w-full bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none">
                <option value="">Todas</option>
              </select>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Tamanho</div>
              <div id="filterTamanho" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Cor</div>
              <div id="filterCor" class="flex flex-wrap gap-2"></div>
            </div>
            <button id="btnLimparFiltros" class="btn w-full mt-2 px-4 py-2 rounded-lg pill">Limpar filtros</button>
          </div>
        </aside>
        <!-- Lista -->
        <div class="flex-1">
          <div class="flex items-center justify-between gap-4 mb-4">
            <h2 class="text-2xl font-bold">Produtos</h2>
            <select id="ordenacao" class="bg-transparent pill px-3 py-2 rounded-lg">
              <option value="relevancia">Relevância</option>
              <option value="menor-preco">Menor preço</option>
              <option value="maior-preco">Maior preço</option>
              <option value="novidades">Novidades</option>
            </select>
          </div>
          <div id="catalogoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 lg:gap-6"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Novidades -->
  <section id="novidades" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold">Novidades e Promoções</h2>
        <span class="badge px-3 py-1 rounded-full">Atualizado semanalmente</span>
      </div>
      <div id="novidadesGrid" class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 lg:gap-6"></div>
    </div>
  </section>

  <!-- Favoritos -->
  <section id="favoritos" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="text-center mb-10">
        <h2 class="text-4xl font-extrabold mb-4">Meus Favoritos</h2>
        <p class="text-slate-300">Produtos que você adorou e salvou para depois</p>
      </div>
      <div id="favoritosGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 lg:gap-6">
        <!-- Produtos favoritos serão renderizados aqui -->
      </div>
      <div id="favoritosVazio" class="text-center py-12 hidden">
        <div class="text-6xl mb-4">💔</div>
        <h3 class="text-xl font-bold mb-2">Nenhum favorito ainda</h3>
        <p class="text-slate-400 mb-6">Explore nossa loja e adicione produtos aos seus favoritos!</p>
        <a href="#loja" data-route class="btn cta-gradient px-6 py-3 rounded-xl font-bold">Explorar Loja</a>
      </div>
    </div>
  </section>

  <!-- Feedbacks -->
  <section id="feedbacks" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Feedbacks de Clientes</h2>
      <div id="feedbackList" class="space-y-4"></div>
      <div class="glass rounded-2xl p-5 mt-6">
        <h3 class="font-bold mb-2">Deixe seu feedback</h3>
        <div class="flex items-center gap-2 mb-3" id="ratingStars">
          <!-- estrelas -->
        </div>
        <textarea id="feedbackText" class="w-full bg-transparent pill p-3 rounded-lg" rows="3" placeholder="Escreva um comentário..."></textarea>
        <div class="mt-3 flex justify-end">
          <button id="btnEnviarFeedback" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Enviar</button>
        </div>
        <p class="hint mt-2">Seu feedback será salvo e exibido para outros clientes.</p>
      </div>
    </div>
  </section>

  <!-- Contato -->
  <section id="contato" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Contato e Redes</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-2">Fale com a TFIMPORTS</h3>
          <div id="chatBox" class="h-56 overflow-y-auto hidden-scroll glass rounded-xl p-3"></div>
          <div class="mt-3 flex gap-2">
            <input id="chatInput" class="flex-1 bg-transparent pill px-3 py-2 rounded-lg" placeholder="Escreva sua mensagem..." />
            <button id="btnChat" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Enviar</button>
          </div>
          <p class="hint mt-2">Nossa equipe responderá em breve. Atendimento 24/7.</p>
        </div>
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-2">Instagram Oficial</h3>
          <p class="text-slate-300">Siga para ver lançamentos, making-of e ofertas exclusivas.</p>
          <a href="https://www.instagram.com/tfimports01/" target="_blank" rel="noopener" class="btn mt-3 px-4 py-2 rounded-lg pill inline-flex items-center gap-2 hover:text-white">📸 Abrir Instagram</a>
          <div class="mt-4 grid grid-cols-3 gap-3" id="instagramPosts">
            <!-- Posts do Instagram serão carregados aqui -->
          </div>
          <div class="mt-4 flex items-center justify-between">
            <p class="hint text-sm">@tfimports01</p>
            <button id="btnRefreshInstagram" class="btn px-3 py-1 rounded-lg text-xs">🔄 Atualizar</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Produto (detalhe) -->
  <section id="produto" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <button class="btn pill px-3 py-2 rounded-lg mb-4" onclick="voltarParaLoja()">← Voltar</button>
      <div id="produtoWrap" class="grid md:grid-cols-2 gap-6">
        <!-- conteudo dinamico -->
      </div>
    </div>
  </section>

  <!-- Carrinho -->
  <section id="carrinho" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Seu Carrinho</h2>
      <div id="cartList" class="space-y-4"></div>
      <div class="mt-4 flex items-center justify-between">
        <div class="text-slate-300">Frete calculado no checkout.</div>
        <div class="text-right">
          <div class="text-sm">Subtotal</div>
          <div class="text-2xl font-extrabold" id="cartSubtotal">R$ 0,00</div>
        </div>
      </div>
      <div class="mt-6 flex gap-3 justify-end">
        <button onclick="navigate('#loja')" class="btn px-4 py-2 rounded-lg pill">Continuar comprando</button>
        <a href="#checkout" data-route class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Fechar pedido</a>
      </div>
    </div>
  </section>

  <!-- Checkout -->
  <section id="checkout" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-2xl font-bold mb-4">Finalizar Compra</h2>
      <div class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Endereço e Frete</h3>
          <div class="space-y-4">
            <!-- CEP -->
            <div>
              <label class="block text-sm text-slate-300 mb-2">CEP *</label>
              <div class="flex gap-2">
                <input id="cep" class="bg-transparent pill px-3 py-2 rounded-lg flex-1" placeholder="00000-000" maxlength="9" />
                <button id="btnBuscarCep" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Buscar</button>
              </div>
              <div id="cepStatus" class="text-xs mt-1"></div>
            </div>
            
            <!-- Endereço -->
          <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-slate-300 mb-2">Logradouro *</label>
                <input id="logradouro" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Rua, Avenida, etc." readonly />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Bairro *</label>
                <input id="bairro" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Bairro" readonly />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Cidade *</label>
                <input id="cidade" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Cidade" readonly />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">UF *</label>
                <input id="uf" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Estado" readonly />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Número *</label>
                <input id="numero" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="123" />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Complemento</label>
                <input id="complemento" class="bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="Apto, casa, etc." />
              </div>
            </div>
            
            <!-- Botão Calcular Frete -->
            <div class="pt-2">
              <button id="btnCalcFrete" class="btn cta-gradient px-6 py-3 rounded-lg font-bold w-full" disabled>
                Calcular Frete
              </button>
            </div>
          </div>
          <div id="freteOpcoes" class="mt-4 grid sm:grid-cols-2 gap-3"></div>

          <!-- Dados Pessoais -->
          <h3 class="font-bold mt-6 mb-3">Dados Pessoais</h3>
          <div class="glass rounded-xl p-6 mb-4">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-slate-300 mb-2">Nome Completo *</label>
                <input id="nome" type="text" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm" placeholder="Seu nome completo" />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Email *</label>
                <input id="email" type="email" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm" placeholder="seu@email.com" />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">Telefone *</label>
                <input id="telefone" type="tel" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm" placeholder="(84) 99999-9999" />
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-2">CPF *</label>
                <input id="cpf" type="text" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm" placeholder="000.000.000-00" maxlength="14" />
              </div>
            </div>
          </div>

          <h3 class="font-bold mt-6 mb-3">Pagamento</h3>
          
          <!-- Seleção de método de pagamento -->
          <div class="glass rounded-xl p-6 mb-4">
            <h4 class="font-bold text-lg mb-4">Escolha a forma de pagamento</h4>
            
            <div class="grid grid-cols-2 gap-3 mb-4">
              <button id="btnPix" class="payment-method-btn btn pill px-4 py-3 rounded-lg text-center" data-method="pix">
                <div class="text-2xl mb-2">📱</div>
                <div class="font-bold">PIX</div>
                <div class="text-xs text-slate-400">Aprovação instantânea</div>
              </button>
              
              <button id="btnCartao" class="payment-method-btn btn pill px-4 py-3 rounded-lg text-center" data-method="card">
              <div class="text-2xl mb-2">💳</div>
                <div class="font-bold">Cartão</div>
                <div class="text-xs text-slate-400">Crédito ou Débito</div>
              </button>
            </div>
          </div>
          
          <!-- Formulário de pagamento -->
          <div id="paymentForm" class="glass rounded-xl p-6 hidden">
            <div id="pixForm" class="payment-form hidden">
              <h4 class="font-bold text-lg mb-4">Pagamento via PIX</h4>
              <p class="text-slate-300 text-sm mb-4">
                O PIX será gerado automaticamente após confirmar o pedido
              </p>
              </div>
            
            <div id="cardForm" class="payment-form hidden">
              <h4 class="font-bold text-lg mb-4">Pagamento com Cartão</h4>
              
              <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                  <label class="block text-sm text-slate-300 mb-2">Número do Cartão</label>
                  <input id="numeroCartao" type="text" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm" placeholder="0000 0000 0000 0000" maxlength="19" />
            </div>
                <div>
                  <label class="block text-sm text-slate-300 mb-2">Validade</label>
                  <input id="validadeCartao" type="text" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm" placeholder="MM/AA" maxlength="5" />
            </div>
              </div>
              
              <div class="grid grid-cols-2 gap-3 mb-4">
                <div>
                  <label class="block text-sm text-slate-300 mb-2">Nome no Cartão</label>
                  <input id="nomeCartao" type="text" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm" placeholder="Nome como no cartão" />
                </div>
                <div>
                  <label class="block text-sm text-slate-300 mb-2">CVV</label>
                  <input id="cvvCartao" type="text" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm" placeholder="123" maxlength="4" />
                </div>
              </div>
              
              <div class="mb-4">
                <label class="block text-sm text-slate-300 mb-2">Parcelamento</label>
                <select id="parcelasCartao" class="w-full bg-slate-800 text-white px-3 py-3 rounded-lg text-sm border border-slate-600 focus:border-emerald-400 focus:outline-none">
                  <option value="1">À vista (1x)</option>
                  <option value="2">2x sem juros</option>
                  <option value="3">3x sem juros</option>
                  <option value="4">4x sem juros</option>
                  <option value="5">5x sem juros</option>
                  <option value="6">6x sem juros</option>
                  <option value="7">7x com juros</option>
                  <option value="8">8x com juros</option>
                  <option value="9">9x com juros</option>
                  <option value="10">10x com juros</option>
                  <option value="11">11x com juros</option>
                  <option value="12">12x com juros</option>
                </select>
                <div id="parcelaInfo" class="text-xs text-slate-400 mt-1"></div>
              </div>
            </div>
            
            <button id="btnFinalizar" class="btn cta-gradient w-full px-4 py-3 rounded-lg font-bold">
              Finalizar Pedido
            </button>
          </div>
        </div>
        <div class="glass rounded-2xl p-5 h-max">
          <h3 class="font-bold mb-3">Resumo</h3>
          <div id="resumoCheckout" class="space-y-2"></div>
          <div class="border-t border-white/10 mt-3 pt-3">
            <div class="flex items-center justify-between">
              <span>Frete</span><span id="resFrete">R$ 0,00</span>
            </div>
            <div class="flex items-center justify-between font-extrabold text-lg mt-1">
              <span>Total</span><span id="resTotal">R$ 0,00</span>
            </div>
          </div>
          <button id="btnFinalizar" class="btn cta-gradient w-full mt-4 px-5 py-3 rounded-xl font-bold">Finalizar Pedido</button>
          <p class="hint mt-2">Seu pedido será processado e você receberá confirmação por email.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Minha Conta -->
  <section id="minha-conta" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-3xl font-bold gradient-title">Minha Conta</h2>
          <p class="text-slate-300 mt-1">Gerencie seus pedidos e informações pessoais</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="userWelcome" class="text-sm hint">Bem-vindo!</span>
          <button id="btnLogoutUser" class="btn px-4 py-2 rounded-lg pill hover:bg-red-500/20 hover:text-red-300">Sair</button>
        </div>
      </div>
      
      <!-- Resumo da Conta -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Informações do Usuário -->
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-emerald-400 to-emerald-600 flex items-center justify-center">
              <span class="text-xl font-bold text-black">👤</span>
            </div>
            <div>
              <h3 class="font-bold text-lg">Perfil</h3>
              <p class="text-sm text-slate-300">Suas informações</p>
            </div>
          </div>
          <div id="userInfo" class="space-y-3">
            <div>
              <div class="text-sm text-slate-300">Nome</div>
              <div id="userName" class="font-bold">-</div>
            </div>
            <div>
              <div class="text-sm text-slate-300">Email</div>
              <div id="userEmail" class="font-bold text-sm">-</div>
            </div>
            <div>
              <div class="text-sm text-slate-300">Membro desde</div>
              <div id="userSince" class="font-bold">-</div>
            </div>
          </div>
        </div>
        
        <!-- Estatísticas -->
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center">
              <span class="text-xl font-bold text-white">📊</span>
            </div>
            <div>
              <h3 class="font-bold text-lg">Estatísticas</h3>
              <p class="text-sm text-slate-300">Seu histórico</p>
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-slate-300">Total de pedidos:</span>
              <span id="totalOrders" class="font-bold">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-300">Valor total:</span>
              <span id="totalSpent" class="font-bold">R$ 0,00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-300">Último pedido:</span>
              <span id="lastOrder" class="font-bold text-sm">-</span>
            </div>
          </div>
        </div>
        
        <!-- Ações Rápidas -->
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-400 to-purple-600 flex items-center justify-center">
              <span class="text-xl font-bold text-white">⚡</span>
            </div>
            <div>
              <h3 class="font-bold text-lg">Ações</h3>
              <p class="text-sm text-slate-300">Acesso rápido</p>
            </div>
          </div>
          <div class="space-y-3">
            <a href="#loja" data-route class="btn w-full px-4 py-2 rounded-lg pill text-center block hover:bg-emerald-500/20">
              🛍️ Continuar Comprando
            </a>
            <a href="#carrinho" data-route class="btn w-full px-4 py-2 rounded-lg pill text-center block hover:bg-blue-500/20">
              🛒 Ver Carrinho
            </a>
            <a href="#feedbacks" data-route class="btn w-full px-4 py-2 rounded-lg pill text-center block hover:bg-yellow-500/20">
              ⭐ Deixar Feedback
            </a>
          </div>
        </div>
      </div>
      
      <!-- Meus Pedidos -->
      <div class="glass rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-green-600 flex items-center justify-center">
              <span class="text-lg font-bold text-white">📦</span>
            </div>
            <div>
              <h3 class="font-bold text-xl">Meus Pedidos</h3>
              <p class="text-sm text-slate-300">Histórico de compras</p>
            </div>
          </div>
          <div class="text-sm text-slate-300">
            Últimos 10 pedidos
          </div>
        </div>
        <div id="userOrders" class="space-y-4">
          <div class="text-slate-300 text-center py-8">
            <div class="text-4xl mb-2">📦</div>
            <div class="text-lg font-bold mb-1">Nenhum pedido encontrado</div>
            <div class="text-sm">Faça sua primeira compra para ver seus pedidos aqui</div>
          </div>
        </div>
      </div>
      
      <!-- Favoritos -->
      <div class="glass rounded-2xl p-6 mt-6">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-red-400 to-red-600 flex items-center justify-center">
            <span class="text-lg font-bold text-white">❤️</span>
          </div>
          <div>
            <h3 class="font-bold text-xl">Produtos Favoritos</h3>
            <p class="text-sm text-slate-300">Seus produtos preferidos</p>
          </div>
        </div>
        <div id="userFavorites" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-slate-300 text-center py-12">
            <div class="text-4xl mb-2">❤️</div>
            <div class="text-lg font-bold mb-1">Nenhum favorito ainda</div>
            <div class="text-sm">Adicione produtos aos favoritos para vê-los aqui</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin -->
  <section id="admin" class="panel">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold">Painel Admin</h2>
        <div class="flex items-center gap-2">
          <span id="authState" class="text-sm hint">Não autenticado</span>
          <button id="btnAdminLogin" class="btn px-4 py-2 rounded-lg pill">Entrar</button>
          <button id="btnLogout" class="btn px-4 py-2 rounded-lg pill hidden">Sair</button>
        </div>
      </div>
      <div class="grid lg:grid-cols-2 gap-6 mt-6">
        <div class="glass rounded-2xl p-5">
          <h3 class="font-bold mb-3">Cadastrar Produto</h3>
          <div class="grid grid-cols-2 gap-3">
            <input id="admNome" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Nome do produto" />
            <select id="admCategoria" class="bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none col-span-2"></select>
            <input id="admPreco" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Preço (R$)" />
            <input id="admPromo" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Preço promocional (opcional)" />
            <div class="col-span-2">
              <div class="mb-2">
                <label class="text-sm text-gray-300 mb-1 block">Imagens do Produto</label>
                <div id="imagensContainer" class="space-y-2">
                  <input type="text" class="imagem-input bg-transparent pill px-3 py-2 rounded-lg w-full" placeholder="URL da imagem 1" />
                </div>
                <button type="button" id="addImagemBtn" class="mt-2 text-emerald-400 hover:text-emerald-300 text-sm flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  Adicionar mais imagens
                </button>
              </div>
            </div>
            <input id="admCores" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Cores (ex.: preto,branco,azul)" />
            <input id="admTamanhos" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" placeholder="Tamanhos (ex.: P,M,G,GG)" />
            <textarea id="admDesc" class="bg-transparent pill px-3 py-2 rounded-lg col-span-2" rows="3" placeholder="Descrição curta"></textarea>
            <input id="admComposicao" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Composição (ex.: 100% Algodão)" />
            <input id="admEstilo" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Estilo (ex.: TFI Signature)" />
            <input id="admEnvio" class="bg-transparent pill px-3 py-2 rounded-lg" placeholder="Envio (ex.: Rápido e rastreável)" />
            <button id="btnSalvarProduto" class="btn cta-gradient px-4 py-2 rounded-lg font-bold col-span-2">Salvar Produto</button>
          </div>
          <p class="hint mt-2">Os produtos são salvos no Firestore e aparecem automaticamente na loja.</p>
        </div>
        <div class="glass rounded-2xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold">Produtos</h3>
            <div class="text-sm text-slate-400">
              Total: <span id="totalProducts">0</span> produtos
            </div>
          </div>
          <div id="adminLista" class="space-y-3 max-h-96 overflow-y-auto hidden-scroll"></div>
        </div>
      </div>
      
      <!-- Seção Coleção Destaque -->
      <div class="mt-6 glass rounded-2xl p-5">
        <h3 class="font-bold mb-3">Coleção Destaque</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <div class="mb-4">
              <label class="text-sm text-slate-300 mb-2 block">Nome da Coleção</label>
              <input id="featuredCollectionName" class="w-full bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none" placeholder="Ex: TFI Black Label" value="TFI Black Label" />
            </div>
            <div class="mb-4">
              <label class="text-sm text-slate-300 mb-2 block">Produtos em Destaque (máx. 3)</label>
              <div id="featuredProductsList" class="space-y-2 max-h-48 overflow-y-auto hidden-scroll">
                <!-- Produtos serão carregados aqui -->
              </div>
            </div>
            <button id="btnSaveFeatured" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">Salvar Coleção</button>
          </div>
          <div>
            <div class="text-sm text-slate-300 mb-2">Preview da Coleção</div>
            <div class="glass rounded-xl p-4 border border-emerald-400/30">
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-semibold">Coleção destaque</span>
                <span class="badge text-xs">Novo</span>
              </div>
              <div class="text-lg font-bold mb-2" id="previewCollectionName">TFI Black Label</div>
              <div class="text-sm text-slate-400 mb-3">Produtos selecionados: <span id="previewProductCount">0</span></div>
              <button class="btn pill px-3 py-1 text-xs">Ver</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Seção Pedidos dos Clientes -->
      <div class="mt-6 glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold">Pedidos dos Clientes</h3>
          <div class="flex items-center gap-2">
            <button id="btnRefreshOrders" class="btn pill px-3 py-2 rounded-lg text-sm">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Atualizar
            </button>
            <div class="text-sm text-slate-400">
              Total: <span id="totalOrders">0</span> pedidos
            </div>
          </div>
        </div>
        
        <!-- Filtros -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
          <select id="filterStatus" class="bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none">
            <option value="">Todos os status</option>
            <option value="pending">Pendente</option>
            <option value="confirmed">Confirmado</option>
            <option value="processing">Processando</option>
            <option value="shipped">Enviado</option>
            <option value="delivered">Entregue</option>
            <option value="cancelled">Cancelado</option>
          </select>
          <select id="filterPayment" class="bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none">
            <option value="">Todos os pagamentos</option>
            <option value="pix">PIX</option>
            <option value="card">Cartão</option>
          </select>
          <input id="filterDate" type="date" class="bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none" />
          <input id="filterSearch" type="text" placeholder="Buscar por nome, email ou ID..." class="bg-slate-800 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-emerald-400 focus:outline-none" />
        </div>
        
        <!-- Lista de Pedidos -->
        <div id="ordersList" class="space-y-3 max-h-96 overflow-y-auto hidden-scroll">
          <!-- Os pedidos serão carregados aqui dinamicamente -->
        </div>
      </div>

      <!-- Seção Gerenciar Feedbacks -->
      <div class="mt-6 glass rounded-2xl p-5">
        <h3 class="font-bold mb-4">Gerenciar Feedbacks</h3>
        <div class="flex items-center justify-between">
          <div>
            <p class="text-slate-300 mb-2">Total de feedbacks: <span id="adminFeedbackCount">0</span></p>
            <p class="text-sm text-slate-400">Gerencie os feedbacks dos clientes</p>
          </div>
          <div class="flex gap-2">
            <button id="btnRefreshFeedbacks" class="btn pill px-3 py-2 rounded-lg text-sm">
              🔄 Atualizar
            </button>
            <button id="btnClearFeedbacks" class="btn bg-red-500 hover:bg-red-600 px-3 py-2 rounded-lg text-sm">
              🗑️ Zerar Feedbacks
            </button>
          </div>
        </div>
      </div>

        </div>
  </section>

  <!-- Modal de Escolha do Tipo de Peça -->
  <div id="tipoPecaModal" class="fixed inset-0 hidden items-center justify-center modal-mask z-50">
    <div class="glass rounded-2xl p-6 max-w-md w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Escolha o tipo da peça</h3>
        <button id="closeTipoPecaModal" class="text-slate-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="space-y-3">
        <button class="w-full btn pill px-4 py-3 text-left" data-tipo="ver">
          <div class="font-semibold">Ver produto</div>
          <div class="text-sm text-slate-400">Visualizar detalhes completos</div>
        </button>
        <button class="w-full btn pill px-4 py-3 text-left" data-tipo="adicionar">
          <div class="font-semibold">Adicionar ao carrinho</div>
          <div class="text-sm text-slate-400">Adicionar diretamente ao carrinho</div>
        </button>
    </div>
    </div>
  </div>

  <!-- Modal PIX -->
  <div id="pixModal" class="fixed inset-0 hidden items-center justify-center modal-mask z-50 p-4">
    <div class="glass rounded-2xl p-6 max-w-md w-full mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">Pagamento via PIX</h3>
        <button id="btnFecharPix" class="text-slate-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="text-center">
        <div class="mb-4">
          <div class="text-4xl mb-2">📱</div>
          <h4 class="font-bold text-lg">Escaneie o QR Code</h4>
          <p class="text-slate-300 text-sm">Use seu app bancário para pagar</p>
        </div>
        
        <div id="pixQrCode" class="bg-white p-4 rounded-lg mb-4 inline-block">
          <!-- QR Code será inserido aqui -->
        </div>
        
        <div class="mb-4">
          <label class="block text-sm text-slate-300 mb-2">Ou copie o código PIX:</label>
          <div class="flex gap-2">
            <input id="pixCode" type="text" class="flex-1 bg-transparent pill px-3 py-2 rounded-lg text-sm" readonly />
            <button id="btnCopiarPix" class="btn pill px-3 py-2 rounded-lg text-sm">Copiar</button>
          </div>
        </div>
        
        <div id="pixStatus" class="mb-4">
          <div class="flex items-center justify-center gap-2 text-blue-400">
            <div class="w-3 h-3 bg-blue-400 rounded-full animate-pulse"></div>
            <span class="text-sm">Aguardando pagamento...</span>
          </div>
        </div>
        
        <div class="text-center mb-4">
          <div class="text-xs text-slate-400">
            🔄 Verificação automática ativa
          </div>
        </div>
        
        <div class="flex gap-3">
          <button id="btnVerificarPix" class="btn cta-gradient px-4 py-2 rounded-lg font-bold">
            Verificar Pagamento
          </button>
          <button id="btnFecharPix2" class="btn pill px-4 py-2 rounded-lg">
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação de Compra -->
  <div id="confirmacaoModal" class="fixed inset-0 hidden items-center justify-center modal-mask z-50 p-4">
    <div class="glass rounded-2xl p-6 max-w-lg w-full mx-auto">
      <div class="text-center">
        <!-- Ícone de sucesso -->
        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="text-2xl">✅</span>
        </div>
        
        <h3 class="text-2xl font-bold text-green-400 mb-2">Compra Realizada!</h3>
        <p class="text-slate-300 mb-6">Seu pedido foi processado com sucesso</p>
        
        <!-- Detalhes do pedido -->
        <div class="bg-slate-800/50 rounded-xl p-4 mb-6 text-left">
          <h4 class="font-bold text-lg mb-3 text-center">Detalhes do Pedido</h4>
          
          <!-- Produtos -->
          <div id="confirmacaoProdutos" class="mb-4">
            <!-- Produtos serão inseridos aqui via JavaScript -->
          </div>
          
          <!-- Dados do cliente -->
          <div class="border-t border-slate-600 pt-3">
            <h5 class="font-bold mb-2">Dados do Cliente:</h5>
            <div id="confirmacaoCliente" class="text-sm text-slate-300">
              <!-- Dados serão inseridos aqui via JavaScript -->
            </div>
          </div>
          
          <!-- Frete -->
          <div class="border-t border-slate-600 pt-3 mt-3">
            <h5 class="font-bold mb-2">Frete:</h5>
            <div id="confirmacaoFrete" class="text-sm text-slate-300">
              <!-- Frete será inserido aqui via JavaScript -->
            </div>
          </div>
          
          <!-- Total -->
          <div class="border-t border-slate-600 pt-3 mt-3">
            <div class="flex justify-between items-center">
              <span class="font-bold text-lg">Total:</span>
              <span id="confirmacaoTotal" class="font-bold text-xl text-green-400">
                <!-- Total será inserido aqui via JavaScript -->
              </span>
            </div>
          </div>
        </div>
        
        <!-- Tempo de entrega -->
        <div class="bg-blue-500/20 border border-blue-500/30 rounded-xl p-4 mb-6">
          <div class="flex items-center justify-center gap-2 mb-2">
            <span class="text-2xl">🚚</span>
            <h5 class="font-bold text-blue-400">Previsão de Entrega</h5>
          </div>
          <p id="confirmacaoEntrega" class="text-sm text-slate-300">
            <!-- Tempo de entrega será inserido aqui via JavaScript -->
          </p>
        </div>
        
        <!-- Informações adicionais -->
        <div class="text-xs text-slate-400 mb-6">
          <p>• Você receberá um email de confirmação em breve</p>
          <p>• O código de rastreamento será enviado quando o pedido for postado</p>
          <p>• Em caso de dúvidas, entre em contato conosco</p>
        </div>
        
        <!-- Botões -->
        <div class="flex gap-3">
          <button id="btnContinuarComprando" class="btn cta-gradient px-6 py-3 rounded-lg font-bold flex-1">
            Continuar Comprando
          </button>
          <button id="btnVerPedidos" class="btn bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-lg font-bold">
            Ver Pedidos
          </button>
          <button id="btnFecharConfirmacao" class="btn pill px-6 py-3 rounded-lg">
            Fechar
          </button>
        </div>
    </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 hidden items-center justify-center modal-mask z-50 p-4">
    <div class="glass rounded-2xl p-4 sm:p-6 max-w-md w-full mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg sm:text-xl font-bold">Entrar na TFIMPORTS</h3>
        <button id="closeLogin" class="btn pill px-3 py-1 rounded-lg text-lg">✕</button>
      </div>
      
      <!-- Login com Email/Senha -->
      <div id="emailLoginForm" class="space-y-4">
        <div>
          <label class="block text-sm text-slate-300 mb-2">Email</label>
          <input id="loginEmail" type="email" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="seu@email.com" />
      </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Senha</label>
          <input id="loginPassword" type="password" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="Sua senha" />
    </div>
        <button id="btnEmailLogin" class="btn cta-gradient w-full px-4 py-3 rounded-lg font-bold text-sm sm:text-base">Entrar</button>
        <div class="flex justify-between items-center">
          <button id="btnShowRegister" class="btn pill px-4 py-2 rounded-lg text-sm sm:text-base">Criar conta</button>
          <button id="btnForgotPassword" class="text-sm text-slate-400 hover:text-slate-300 transition-colors">Esqueci a senha</button>
        </div>
  </div>
      
      <!-- Recuperação de Senha -->
      <div id="forgotPasswordForm" class="space-y-4 hidden">
        <div class="text-center mb-4">
          <h3 class="text-lg font-bold text-white mb-2">Recuperar Senha</h3>
          <p class="text-sm text-slate-400">Digite seu email para receber instruções de recuperação</p>
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Email</label>
          <input id="forgotEmail" type="email" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="seu@email.com" />
        </div>
        <button id="btnSendReset" class="btn cta-gradient w-full px-4 py-3 rounded-lg font-bold text-sm sm:text-base">Enviar Instruções</button>
        <button id="btnBackToLogin" class="btn pill w-full px-4 py-2 rounded-lg text-sm sm:text-base">Voltar ao Login</button>
      </div>
      
      <!-- Registro com Email/Senha -->
      <div id="registerForm" class="space-y-4 hidden">
        <div>
          <label class="block text-sm text-slate-300 mb-2">Nome</label>
          <input id="registerName" type="text" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="Seu nome completo" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Email</label>
          <input id="registerEmail" type="email" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="seu@email.com" />
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-2">Senha</label>
          <input id="registerPassword" type="password" class="w-full bg-transparent pill px-3 py-3 rounded-lg text-sm sm:text-base" placeholder="Mínimo 6 caracteres" />
        </div>
        <button id="btnEmailRegister" class="btn cta-gradient w-full px-4 py-3 rounded-lg font-bold text-sm sm:text-base">Criar Conta</button>
        <button id="btnShowLogin" class="btn pill w-full px-4 py-2 rounded-lg text-sm sm:text-base">Já tenho conta</button>
      </div>
      
      <!-- Divisor -->
      <div class="flex items-center my-4">
        <div class="flex-1 border-t border-white/20"></div>
        <span class="px-3 text-sm text-slate-400">ou</span>
        <div class="flex-1 border-t border-white/20"></div>
      </div>
      
      <!-- Login com Google -->
      <button id="btnGoogleLogin" class="btn pill w-full px-4 py-3 rounded-lg flex items-center justify-center gap-3 text-sm sm:text-base">
        <svg width="20" height="20" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Entrar com Google
      </button>
      
      <div class="mt-4 text-xs text-center hint">
        Ao entrar, você concorda com nossos termos de uso.
      </div>
    </div>
  </div>



  <!-- Footer -->
  <footer class="mt-16 border-t border-white/10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-8 grid md:grid-cols-3 gap-6">
      <div>
        <div class="text-lg font-extrabold gradient-title">TFIMPORTS</div>
        <p class="text-slate-300 mt-2">Estilo premium com atitude. Atendimento direto no site.</p>
      </div>
      <div>
        <div class="font-bold mb-2">Categorias</div>
        <div id="footerCats" class="flex flex-wrap gap-2"></div>
      </div>
      <div>
        <div class="font-bold mb-2">Links</div>
        <div class="flex flex-col gap-1">
          <a href="#loja" data-route class="hover:text-emerald-300">Loja</a>
          <a href="#novidades" data-route class="hover:text-emerald-300">Novidades</a>
          <a href="#feedbacks" data-route class="hover:text-emerald-300">Feedbacks</a>
          <a href="#contato" data-route class="hover:text-emerald-300">Contato</a>
        </div>
      </div>
    </div>
    
    <!-- Elementos centralizados -->
    <div class="text-center mt-8 pt-8 border-t border-white/10">
      <div class="text-xs hint mb-2">© <span id="year"></span> TFIMPORTS. Todos os direitos reservados.</div>
      <div class="text-xs hint">
        Desenvolvido por <a href="https://agenciaelevare.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:text-emerald-300 transition-colors">Agência Elevare</a>
      </div>
    </div>
  </footer>

  <!-- Definir funções utilitárias globalmente -->
  <script>
    // Definir funções no escopo global para evitar erros
    window.qs = s => document.querySelector(s);
    window.qsa = s => Array.from(document.querySelectorAll(s));
    window.fmt = v => v.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
  </script>

  <script type="module" data-timestamp="20241220-002">
    // Importar funções de segurança
    import { checkRateLimit, sanitizeText, validateProduct } from './security.js';
    
    // Importar serviços de integração
    import { asaasService } from './asaas.js';
    import { superFreteService } from './super-frete.js';
    import { OrderManager } from './order-manager.js';
    import { validateConfig } from './api-config.js';
    
    // Utilidades - definidas primeiro para evitar erros
    const fmt = window.fmt;
    const qs = window.qs;
    const qsa = window.qsa;
    
    // Verificar se as funções estão definidas
    if (typeof qs !== 'function') {
      console.error('❌ Função qs não está definida!');
    }
    
    // Estado global (local)
    const state = {
      user: null,
      adminEmail: 'souza.henrique007@gmail.com', // Email do administrador
      favoritos: [], // Array de IDs dos produtos favoritos
      featuredCollection: {
        name: 'TFI Black Label',
        products: [] // Array de IDs dos produtos em destaque (máx. 3)
      },
      categorias: [
        "Camisetas","Calças","Bermudas de linho","Bermudas de sarja","Cueca premium",
        "Camiseta dry fit","Camisa peruana","Camisa polo","Regata USA","Meias","Bermuda high"
      ],
      produtos: [
        // Produtos fake removidos - apenas produtos reais do Firestore serão exibidos
      ],
      carrinho: [],
      freteSelecionado: null
    };

    // Variáveis globais para pagamento
    let selectedPaymentMethod = null;
    let currentPaymentId = null;
    let pixVerificationInterval = null;

    // Utilidades já definidas acima
    
    // Verificar se usuário é admin
    function isAdmin() {
      return state.user && state.user.email === state.adminEmail;
    }
    
    // Verificar se há dados de usuário salvos localmente (fallback)
    function checkLocalUserData() {
      try {
        const localUser = localStorage.getItem('tfi_user');
        if (localUser && !state.user) {
          const userData = JSON.parse(localUser);
          // Só usar dados locais se o Firebase não estiver disponível
          if (!auth) {
            state.user = userData;
            updateAuthUI();
            console.log('Usando dados de usuário salvos localmente');
          }
        }
      } catch (error) {
        console.error('Erro ao verificar dados locais do usuário:', error);
      }
    }
    
    // Salvar dados do usuário localmente como backup
    function saveLocalUserData() {
      if (state.user) {
        try {
          localStorage.setItem('tfi_user', JSON.stringify({
            uid: state.user.uid,
            email: state.user.email,
            displayName: state.user.displayName
          }));
        } catch (error) {
          console.error('Erro ao salvar dados locais do usuário:', error);
        }
      } else {
        localStorage.removeItem('tfi_user');
      }
    }

    // Navegação SPA
    function navigate(hash) {
      window.location.hash = hash;
    }
    
    
    function applyRoute() {
      const hash = window.location.hash || "#home";
      qsa('[data-route]').forEach(a => a.classList.toggle('nav-active', a.getAttribute('href') === hash));
      qsa('.panel').forEach(p => p.classList.remove('active'));
      const id = hash.replace('#','');
      
      // Fechar menu mobile ao navegar
      qs('#mobileNav').classList.add('hidden');
      
      // Proteger painel admin - apenas admin pode acessar
      if (id === 'admin') {
        if (!state.user) {
          toast('Faça login para acessar o painel administrativo.');
          navigate('#home');
          return;
        }
        if (!isAdmin()) {
          toast('Acesso negado. Apenas administradores podem acessar esta área.');
          navigate('#home');
          return;
        }
      }
      
      // Proteger minha conta - apenas usuários logados
      if (id === 'minha-conta' && !state.user) {
        toast('Faça login para acessar sua conta.');
        navigate('#home');
        return;
      }
      
      const panel = qs('#'+id);
      if (panel) panel.classList.add('active');
      if (id === 'produto') renderProdutoDetalhe();
      if (id === 'carrinho') renderCarrinho();
      if (id === 'favoritos') renderFavoritos();
      if (id === 'checkout') renderCheckoutResumo();
      if (id === 'minha-conta') renderMinhaConta();
    }
    // Event listeners para navegação - aguardar DOM estar pronto
    document.addEventListener('DOMContentLoaded', () => {
      window.addEventListener('hashchange', applyRoute);
      window.addEventListener('popstate', applyRoute);
      applyRoute(); // Aplicar rota inicial
    });

    // Função para inicializar todos os event listeners
    window.initEventListeners = function() {
    // Header behaviors
      const btnMenu = window.qs('#btnMenu');
      if (btnMenu) {
        btnMenu.addEventListener('click', () => {
          const mobileNav = window.qs('#mobileNav');
          if (mobileNav) {
            mobileNav.classList.toggle('hidden');
          }
        });
      }
      
      // Outros event listeners que usam qs
      if (window.initOtherEventListeners) {
        window.initOtherEventListeners();
      }
    }
    
    // Função para outros event listeners
    window.initOtherEventListeners = function() {
      // Buscar CEP
      const btnBuscarCep = window.qs('#btnBuscarCep');
      if (btnBuscarCep) {
        btnBuscarCep.addEventListener('click', async () => {
          const cepInput = window.qs('#cep');
          const cep = cepInput.value.replace(/\D/g, '');
          const statusDiv = window.qs('#cepStatus');
          
          if (cep.length !== 8) {
            statusDiv.textContent = 'CEP deve ter 8 dígitos';
            statusDiv.className = 'text-xs mt-1 text-red-400';
            return;
          }
          
          statusDiv.textContent = 'Buscando CEP...';
          statusDiv.className = 'text-xs mt-1 text-blue-400';
          qs('#btnBuscarCep').disabled = true;
          
          try {
            const result = await superFreteService.validateCEP(cep);
            
            if (result.success) {
              // Preencher campos automaticamente
              qs('#logradouro').value = result.logradouro || '';
              qs('#bairro').value = result.bairro || '';
              qs('#cidade').value = result.cidade || '';
              qs('#uf').value = result.uf || '';
              
              // Formatar CEP
              cepInput.value = result.cep;
              
              statusDiv.textContent = 'CEP encontrado! Preencha o número e complemento.';
              statusDiv.className = 'text-xs mt-1 text-green-400';
              
              // Habilitar botão de calcular frete
              qs('#btnCalcFrete').disabled = false;
              
              // Focar no campo número
              qs('#numero').focus();
            } else {
              statusDiv.textContent = result.error;
              statusDiv.className = 'text-xs mt-1 text-red-400';
            }
            
          } catch (error) {
            console.error('Erro ao validar CEP:', error);
            statusDiv.textContent = 'Erro ao validar CEP. Tente novamente.';
            statusDiv.className = 'text-xs mt-1 text-red-400';
          } finally {
            const btnBuscarCep = qs('#btnBuscarCep');
            if (btnBuscarCep) {
              btnBuscarCep.disabled = false;
            }
          }
        });
      }

      // Buscar CEP ao pressionar Enter
      const cepInput2 = qs('#cep');
      if (cepInput2) {
        cepInput2.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const btnBuscarCep = qs('#btnBuscarCep');
            if (btnBuscarCep) {
              btnBuscarCep.click();
            }
          }
        });
      }

      // Validar endereço completo antes de calcular frete
      const btnCalcFrete = qs('#btnCalcFrete');
      if (btnCalcFrete) {
        btnCalcFrete.addEventListener('click', async () => {
          const op = qs('#freteOpcoes'); 
          op.innerHTML='<div class="hint text-center py-4">Calculando frete...</div>';
          
          // Coletar dados do endereço
          const addressData = {
            cep: qs('#cep').value.replace(/\D/g, ''),
            logradouro: qs('#logradouro').value,
            bairro: qs('#bairro').value,
            cidade: qs('#cidade').value,
            uf: qs('#uf').value,
            numero: qs('#numero').value,
            complemento: qs('#complemento').value
          };
          
          // Validar endereço
          const validation = superFreteService.validateAddress(addressData);
          if (!validation.isValid) {
            op.innerHTML = `<div class="hint text-center py-4">Erro: ${validation.errors.join(', ')}</div>`;
            return;
          }
          
          try {
            // Calcular frete com Super Frete
            const shippingData = {
              cepDestino: addressData.cep,
              produtos: state.carrinho.map(item => ({
                id: item.id,
                nome: item.nome,
                preco: item.preco,
                quantidade: item.qtd,
                peso: 0.3 // Peso padrão em kg
              })),
              pesoTotal: state.carrinho.reduce((total, item) => total + (0.3 * item.qtd), 0)
            };
            
            // Verificar se carrinho tem itens
            if (!state.carrinho || state.carrinho.length === 0) {
              console.log('❌ Carrinho vazio, recarregando...');
              loadCart(); // Recarregar carrinho
              if (!state.carrinho || state.carrinho.length === 0) {
                op.innerHTML = `<div class="hint text-center py-4">Erro: Carrinho vazio. Adicione produtos antes de calcular frete.</div>`;
                return;
              }
            }
            
            // Calcular frete com Super Frete
            const pesoTotal = state.carrinho.reduce((total, item) => total + (0.3 * item.qtd), 0);
            const valorTotal = state.carrinho.reduce((total, item) => total + (item.preco * item.qtd), 0);
            
            // Dimensões padrão para o produto
            const dimensoes = {
              height: 2, // cm
              width: 11, // cm
              length: 16 // cm
            };
            
            // Validar CEP antes de enviar
            const cep = addressData.cep.replace(/\D/g, '');
            if (cep.length !== 8) {
              op.innerHTML = `<div class="hint text-center py-4">Erro: CEP inválido (${addressData.cep})</div>`;
              return;
            }
            
            console.log('🚚 Calculando frete:', { cep, pesoTotal, valorTotal, dimensoes, carrinho: state.carrinho.length });
            
            const result = await superFreteService.calculateShipping(
              cep,
              pesoTotal,
              valorTotal,
              dimensoes
            );
            
            console.log('📦 Resultado do frete:', result);
            
            if (result.success && result.options && result.options.length > 0) {
              op.innerHTML = '';
              
              result.options.forEach(option => {
                const d = document.createElement('label');
                const isMiniEnvios = option.id === 'mini-envios';
                const isBestPrice = option.name === 'Mini Envios' || option.description?.includes('Melhor preço');
                d.className = `glass rounded-xl p-3 flex items-center justify-between cursor-pointer hover:ring-2 hover:ring-emerald-400/40 ${isBestPrice ? 'ring-2 ring-emerald-400/60 bg-emerald-400/5' : ''}`;
                d.innerHTML = `
                  <div>
                    <div class="font-bold flex items-center gap-2">
                      ${option.name}
                      ${isBestPrice ? '<span class="bg-emerald-500 text-white text-xs px-2 py-1 rounded-full">Melhor preço</span>' : ''}
                    </div>
                    <div class="hint text-sm">${option.company} • ${option.delivery_time}</div>
                    ${option.description ? `<div class="text-xs text-emerald-400 mt-1">${option.description}</div>` : ''}
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="font-extrabold">${fmt(option.price)}</div>
                    <input type="radio" name="frete" value="${option.id}" data-company="${option.company_id}">
                  </div>
                `;
                op.appendChild(d);
              });
              
              op.onclick = (e) => {
                const r = e.target.closest('input[type=radio]'); 
                if (!r) return;
                
                // Opção de frete real
                const selectedOption = result.options.find(opt => opt.id === r.value);
                state.freteSelecionado = {
                  id: selectedOption.id,
                  nome: selectedOption.name,
                  empresa: selectedOption.company,
                  preco: selectedOption.price,
                  prazo: `${selectedOption.delivery_time} dias úteis`,
                  company_id: selectedOption.company_id
                };
                
                // Salvar endereço completo no estado
                state.enderecoCompleto = addressData;
                
                updateTotals();
                toast('Frete selecionado!');
              };
              
            } else {
              console.error('❌ Erro no cálculo de frete:', result);
              const errorMsg = result.error || 'Não foi possível calcular o frete para este endereço.';
              op.innerHTML = `
                <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-4 text-center">
                  <div class="text-red-400 font-medium mb-2">❌ Erro no cálculo de frete</div>
                  <div class="text-sm text-red-300">${errorMsg}</div>
                  <div class="text-xs text-red-400 mt-2">Tente novamente em alguns minutos</div>
                </div>
              `;
            }
            
          } catch (error) {
            console.error('❌ Erro ao calcular frete:', error);
            op.innerHTML = `
              <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-4 text-center">
                <div class="text-red-400 font-medium mb-2">❌ Erro de conexão</div>
                <div class="text-sm text-red-300">Não foi possível conectar com o serviço de frete</div>
                <div class="text-xs text-red-400 mt-2">Verifique sua conexão e tente novamente</div>
              </div>
            `;
          }
        });
      }

      // Event listeners para pagamento
      const btnPix = qs('#btnPix');
      if (btnPix) {
        btnPix.addEventListener('click', () => selectPaymentMethod('pix'));
      }
      
      const btnCartao = qs('#btnCartao');
      if (btnCartao) {
        btnCartao.addEventListener('click', () => selectPaymentMethod('card'));
      }
      
      const btnFecharPix = qs('#btnFecharPix');
      if (btnFecharPix) {
        btnFecharPix.addEventListener('click', closePixModal);
      }
      
      const btnFecharPix2 = qs('#btnFecharPix2');
      if (btnFecharPix2) {
        btnFecharPix2.addEventListener('click', closePixModal);
      }
      
      const btnVerificarPix = qs('#btnVerificarPix');
      if (btnVerificarPix) {
        btnVerificarPix.addEventListener('click', async () => {
          if (currentPaymentId) {
            try {
              const status = await asaasService.getPaymentStatus(currentPaymentId);
              if (status.status === 'CONFIRMED') {
                toast('Pagamento confirmado!');
                closePixModal();
                showConfirmacaoModal();
              } else {
                toast('Pagamento ainda não confirmado');
              }
            } catch (error) {
              console.error('Erro ao verificar pagamento:', error);
              toast('Erro ao verificar pagamento');
            }
          }
        });
      }
    }
    
    // Inicializar quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      if (window.initEventListeners) {
        window.initEventListeners();
      } else {
        console.error('❌ initEventListeners não está definida!');
      }
    });

    // Render categorias chips/footer
    function renderChips() {
      const chips = qs('#categoryChips');
      if (!chips) return;
      
      chips.innerHTML = '';
      state.categorias.forEach(cat => {
        const a = document.createElement('a');
        a.href = '#loja';
        a.setAttribute('data-route','');
        a.className = 'pill px-4 py-2 rounded-full hover:text-emerald-300';
        a.textContent = cat;
        a.addEventListener('click', () => {
          const filterCategoria = qs('#filterCategoria');
          if (filterCategoria) {
            filterCategoria.value = cat;
          }
          filterAndRenderCatalog();
        });
        chips.appendChild(a);
      });
      const footerCats = qs('#footerCats');
      if (footerCats) {
      footerCats.innerHTML = '';
      state.categorias.slice(0,6).forEach(cat => {
        const span = document.createElement('span');
        span.className = 'pill px-3 py-1 rounded-full text-sm';
        span.textContent = cat;
        footerCats.appendChild(span);
      });
      }
    }

    // Produto card com imagem ou placeholder
    function produtoThumb(produto) {
      const imagens = produto.imagens || (produto.imagem ? [produto.imagem] : []);
      
      if (imagens.length > 0) {
        const imageId = `produto-${produto.id || Math.random()}`;
        return `
          <div class="card-img rounded-2xl aspect-[4/3] overflow-hidden relative group">
            <div class="imagem-gallery" data-gallery-id="${imageId}">
              ${imagens.map((img, index) => `
                <img src="${img}" alt="${produto.nome}" 
                     class="w-full h-full object-cover transition-opacity duration-300 ${index === 0 ? 'opacity-100' : 'opacity-0 absolute top-0 left-0'}" 
                     data-index="${index}"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-full h-full flex items-center justify-center bg-gray-800 absolute top-0 left-0" style="display:none;">
                  <svg viewBox="0 0 140 100" class="w-24 h-24">
                    <rect x="10" y="10" width="120" height="80" rx="12" fill="#0b1a34"/>
                    <path d="M20 75 L55 35 L85 55 L120 25" stroke="#1dd1a1" stroke-width="5" fill="none"/>
                  </svg>
                </div>
              `).join('')}
            </div>
            ${imagens.length > 1 ? `
              <div class="absolute inset-0 flex items-center justify-between p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <button class="gallery-prev bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-colors" data-gallery-id="${imageId}">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <button class="gallery-next bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-colors" data-gallery-id="${imageId}">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
              <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex gap-1">
                ${imagens.map((_, index) => `
                  <div class="gallery-dot w-2 h-2 rounded-full bg-white/50 hover:bg-white/80 cursor-pointer transition-colors ${index === 0 ? 'bg-white' : ''}" 
                       data-gallery-id="${imageId}" data-index="${index}"></div>
                `).join('')}
              </div>
            ` : ''}
          </div>`;
      } else {
        return `
          <div class="card-img rounded-2xl aspect-[4/3] grid place-items-center">
            <svg viewBox="0 0 140 100" class="w-24 h-24">
              <rect x="10" y="10" width="120" height="80" rx="12" fill="#0b1a34"/>
              <path d="M20 75 L55 35 L85 55 L120 25" stroke="#1dd1a1" stroke-width="5" fill="none"/>
            </svg>
          </div>`;
      }
    }

    // Destaques
    function renderDestaques() {
      const grid = qs('#featuredGrid');
      grid.innerHTML = '';
      
      // Usar produtos da coleção destaque personalizada
      const featuredProducts = state.featuredCollection.products
        .map(id => state.produtos.find(p => p.id === id))
        .filter(Boolean)
        .slice(0, 3);
      
      // Se não houver produtos na coleção, usar produtos com destaque
      const productsToShow = featuredProducts.length > 0 ? featuredProducts : state.produtos.filter(p => p.destaque).slice(0,6);
      
      productsToShow.forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden hover:ring-2 hover:ring-emerald-400/40';
        el.innerHTML = `
          ${produtoThumb(p)}
          <div class="p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-bold">${p.nome}</h3>
              ${p.novas ? '<span class="badge px-2 py-1 rounded-full text-xs">Novo</span>' : ''}
            </div>
            <div class="mt-1 text-sm hint">${p.categoria}</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
              <button class="btn px-3 py-2 rounded-lg pill favorito-btn" data-id="${p.id}" data-action="favoritar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      grid.addEventListener('click', async e => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') { openProduto(id); }
        if (act === 'add') { openTipoPecaModal(id); }
        if (act === 'favoritar') { await toggleFavorito(id); }
      });
      
      // Atualizar também a seção de preview na home
      renderFeaturedProductsPreview();
    }
    
    // Preview dos produtos na seção destaque da home
    function renderFeaturedProductsPreview() {
      const preview = qs('#featuredProductsPreview');
      if (!preview) return;
      
      preview.innerHTML = '';
      
      // Usar produtos da coleção destaque personalizada
      const featuredProducts = state.featuredCollection.products
        .map(id => state.produtos.find(p => p.id === id))
        .filter(Boolean)
        .slice(0, 3);
      
      // Se não houver produtos na coleção, usar produtos com destaque
      const productsToShow = featuredProducts.length > 0 ? featuredProducts : state.produtos.filter(p => p.destaque).slice(0, 3);
      
      // Preencher com até 3 produtos
      for (let i = 0; i < 3; i++) {
        const produto = productsToShow[i];
        const div = document.createElement('div');
        div.className = 'card-img rounded-2xl h-36 overflow-hidden cursor-pointer hover:ring-2 hover:ring-emerald-400/40 transition-all relative';
        
        if (produto) {
          div.innerHTML = `
            ${(produto.imagens && produto.imagens[0]) || produto.imagem ? 
              `<img src="${(produto.imagens && produto.imagens[0]) || produto.imagem}" alt="${produto.nome}" class="w-full h-full object-cover" 
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
               <div class="w-full h-full flex items-center justify-center bg-gray-800" style="display:none;">
                 <svg viewBox="0 0 120 120" class="w-16 h-16">
                   <rect x="10" y="10" width="100" height="100" rx="16" fill="#0b1a34"/>
                   <path d="M20 90 L45 40 L75 60 L100 30" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                 </svg>
               </div>` :
              `<div class="w-full h-full flex items-center justify-center bg-gray-800">
                 <svg viewBox="0 0 120 120" class="w-16 h-16">
                   <rect x="10" y="10" width="100" height="100" rx="16" fill="#0b1a34"/>
                   <path d="M20 90 L45 40 L75 60 L100 30" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                 </svg>
               </div>`
            }
            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all flex items-end p-2">
              <div class="text-white text-xs font-semibold truncate w-full">${produto.nome}</div>
            </div>
          `;
          div.addEventListener('click', () => openProduto(produto.id));
        } else {
          // Placeholder vazio
          div.innerHTML = `
            <div class="w-full h-full flex items-center justify-center bg-gray-800">
              <svg viewBox="0 0 120 120" class="w-16 h-16">
                <rect x="10" y="10" width="100" height="100" rx="16" fill="#0b1a34"/>
                <path d="M20 90 L45 40 L75 60 L100 30" stroke="#1dd1a1" stroke-width="6" fill="none"/>
              </svg>
            </div>
          `;
        }
        
        preview.appendChild(div);
      }
    }

    // Loja: filtros
    function initFilters() {
      const sel = qs('#filterCategoria');
      if (sel) {
      state.categorias.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      });
      }
      
      const sizes = ["PP","P","M","G","GG","XG"];
      const wrapT = qs('#filterTamanho');
      if (!wrapT) return;
      sizes.forEach(t => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill text-sm';
        b.textContent = t;
        b.addEventListener('click', () => {
          b.classList.toggle('badge');
          filterAndRenderCatalog();
        });
        wrapT.appendChild(b);
      });
      const cores = ["preto","branco","azul","verde","cinza","areia"];
      const wrapC = qs('#filterCor');
      cores.forEach(c => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill text-sm capitalize';
        b.textContent = c;
        b.addEventListener('click', () => {
          b.classList.toggle('badge');
          filterAndRenderCatalog();
        });
        wrapC.appendChild(b);
      });
      const btnLimparFiltros = qs('#btnLimparFiltros');
      if (btnLimparFiltros) {
        btnLimparFiltros.addEventListener('click', () => {
          const filterCategoria = qs('#filterCategoria');
          if (filterCategoria) {
            filterCategoria.value = '';
          }
        qsa('#filterTamanho button, #filterCor button').forEach(b => b.classList.remove('badge'));
        filterAndRenderCatalog();
      });
      }
      
      const ordenacao = qs('#ordenacao');
      if (ordenacao) {
        ordenacao.addEventListener('change', filterAndRenderCatalog);
      }
    }
    function filterAndRenderCatalog() {
      const grid = qs('#catalogoGrid');
      if (!grid) return;
      
      const filterCategoria = qs('#filterCategoria');
      const cat = filterCategoria ? filterCategoria.value : '';
      
      const sizesSel = qsa('#filterTamanho button.badge').map(b => b.textContent.trim());
      const coresSel = qsa('#filterCor button.badge').map(b => b.textContent.trim());
      let arr = [...state.produtos];
      if (cat) arr = arr.filter(p => p.categoria === cat);
      if (sizesSel.length) arr = arr.filter(p => p.tamanhos.some(t => sizesSel.includes(t)));
      if (coresSel.length) arr = arr.filter(p => p.cores.some(c => coresSel.includes(c)));
      
      const ordenacao = qs('#ordenacao');
      const ord = ordenacao ? ordenacao.value : '';
      if (ord === 'menor-preco') arr.sort((a,b)=>(a.promo ?? a.preco) - (b.promo ?? b.preco));
      if (ord === 'maior-preco') arr.sort((a,b)=>(b.promo ?? b.preco) - (a.promo ?? a.preco));
      if (ord === 'novidades') arr.sort((a,b)=> (b.novas?-1:1));
      grid.innerHTML = '';
      arr.forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden hover:ring-2 hover:ring-emerald-400/40';
        el.innerHTML = `
          ${produtoThumb(p)}
          <div class="p-4">
            <h3 class="font-bold">${p.nome}</h3>
            <div class="mt-1 text-sm hint">${p.categoria}</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
              <button class="btn px-3 py-2 rounded-lg pill favorito-btn" data-id="${p.id}" data-action="favoritar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      // Remover event listeners antigos e adicionar novo
      grid.replaceWith(grid.cloneNode(true));
      const newGrid = qs('#catalogoGrid');
      newGrid.addEventListener('click', (e) => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') openProduto(id);
        if (act === 'add') addToCart(id);
      });
    }

    // Novidades
    function renderNovidades() {
      const grid = qs('#novidadesGrid');
      grid.innerHTML = '';
      state.produtos.filter(p=>p.novas || p.promo).slice(0,8).forEach(p => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden';
        el.innerHTML = `
          ${produtoThumb(p)}
          <div class="p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-bold">${p.nome}</h3>
              ${p.promo ? '<span class="badge px-2 py-1 rounded-full text-xs">Promo</span>' : '<span class="badge px-2 py-1 rounded-full text-xs">Lançamento</span>'}
            </div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
              <button class="btn px-3 py-2 rounded-lg pill favorito-btn" data-id="${p.id}" data-action="favoritar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      // Remover event listeners antigos e adicionar novo
      grid.replaceWith(grid.cloneNode(true));
      const newGrid = qs('#novidadesGrid');
      newGrid.addEventListener('click', (e) => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') openProduto(id);
        if (act === 'add') addToCart(id);
      });
    }

    // Produto detalhe
    let currentProdutoId = null;
    function openProduto(id) {
      currentProdutoId = id;
      navigate('#produto');
    }
    function renderProdutoDetalhe() {
      const p = state.produtos.find(x=>x.id===currentProdutoId) || state.produtos[0];
      const wrap = qs('#produtoWrap');
      wrap.innerHTML = `
        <div class="glass rounded-2xl p-5">
          <div class="produto-gallery-container">
            <!-- Imagem Principal -->
            <div class="main-image-container relative rounded-xl overflow-hidden bg-gray-800 aspect-square group cursor-zoom-in" id="mainImageContainer">
              ${(p.imagens && p.imagens.length > 0) || p.imagem ? 
                `<div class="main-image-gallery" data-gallery-id="produto-detalhe-${p.id}">
                  ${((p.imagens && p.imagens.length > 0) ? p.imagens : [p.imagem]).map((img, index) => `
                    <img src="${img}" alt="${p.nome}" 
                         class="w-full h-full object-cover transition-opacity duration-300 ${index === 0 ? 'opacity-100' : 'opacity-0 absolute top-0 left-0'}" 
                         data-index="${index}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-full h-full flex items-center justify-center text-gray-400 absolute top-0 left-0" style="display:none;">
                      <svg viewBox="0 0 160 160" class="w-40 h-40">
                        <rect x="15" y="15" width="130" height="130" rx="16" fill="#0b1a34"/>
                        <path d="M30 120 L70 60 L110 80 L135 45" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                      </svg>
                    </div>
                  `).join('')}
                </div>
                ${((p.imagens && p.imagens.length > 1) || (p.imagem && p.imagens && p.imagens.length > 0)) ? `
                  <!-- Navegação por Setas -->
                  <div class="absolute inset-0 flex items-center justify-between p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <button class="gallery-prev bg-black/50 hover:bg-black/70 text-white p-3 rounded-full transition-colors" data-gallery-id="produto-detalhe-${p.id}">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                      </svg>
                    </button>
                    <button class="gallery-next bg-black/50 hover:bg-black/70 text-white p-3 rounded-full transition-colors" data-gallery-id="produto-detalhe-${p.id}">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </button>
                  </div>
                  <!-- Indicador de Zoom -->
                  <div class="absolute top-4 right-4 bg-black/50 text-white px-3 py-1 rounded-full text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    Clique para ampliar
                  </div>
                ` : ''}` :
                `<div class="w-full h-full flex items-center justify-center text-gray-400">
                  <svg viewBox="0 0 160 160" class="w-40 h-40">
                    <rect x="15" y="15" width="130" height="130" rx="16" fill="#0b1a34"/>
                    <path d="M30 120 L70 60 L110 80 L135 45" stroke="#1dd1a1" stroke-width="6" fill="none"/>
                  </svg>
                </div>`
              }
            </div>
            
            <!-- Miniaturas -->
            ${(p.imagens && p.imagens.length > 1) || (p.imagem && p.imagens && p.imagens.length > 0) ? `
              <div class="thumbnails-container mt-4">
                <div class="flex gap-2 overflow-x-auto pb-2">
                  ${((p.imagens && p.imagens.length > 0) ? p.imagens : [p.imagem]).map((img, index) => `
                    <div class="thumbnail-item flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden cursor-pointer border-2 border-transparent hover:border-emerald-400 transition-colors ${index === 0 ? 'border-emerald-400' : ''}" 
                         data-gallery-id="produto-detalhe-${p.id}" data-index="${index}">
                      <img src="${img}" alt="${p.nome} - Imagem ${index + 1}" 
                           class="w-full h-full object-cover"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                      <div class="w-full h-full flex items-center justify-center text-gray-400 bg-gray-800" style="display:none;">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
        <div>
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-extrabold">${p.nome}</h1>
            ${p.novas ? '<span class="badge px-3 py-1 rounded-full">Novo</span>' : ''}
          </div>
          <div class="text-sm hint mt-1">${p.categoria}</div>
          <div class="mt-3 flex items-center gap-3">
            <div class="text-3xl font-extrabold">${fmt(p.promo ?? p.preco)}</div>
            ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
          </div>
          <p class="mt-4 text-slate-300">${p.descricao}</p>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <div>
              <div class="text-sm text-slate-300 mb-2">Cor</div>
              <div id="selCores" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
              <div class="text-sm text-slate-300 mb-2">Tamanho</div>
              <div id="selTamanhos" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
          <div class="mt-5 flex gap-3">
            <button id="btnAddDetail" class="btn cta-gradient px-5 py-3 rounded-xl font-bold">Adicionar ao carrinho</button>
            <button class="btn px-5 py-3 rounded-xl pill" onclick="navigate('#carrinho')">Ver carrinho</button>
          </div>
          <div class="mt-6 grid grid-cols-3 gap-3">
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Composição</div><div class="hint">${p.composicao}</div></div>
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Estilo</div><div class="hint">${p.estilo}</div></div>
            <div class="glass rounded-xl p-3"><div class="text-sm font-bold">Envio</div><div class="hint">${p.envio || 'Rápido e rastreável'}</div></div>
          </div>
        </div>
      `;
      const cores = qs('#selCores'); const tams = qs('#selTamanhos');
      p.cores.forEach(c => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill capitalize';
        b.textContent = c;
        b.addEventListener('click', () => {
          qsa('#selCores button').forEach(x => x.classList.remove('badge')); b.classList.add('badge');
        });
        cores.appendChild(b);
      });
      p.tamanhos.forEach(t => {
        const b = document.createElement('button');
        b.className = 'btn px-3 py-1 rounded-full pill';
        b.textContent = t;
        b.addEventListener('click', () => {
          qsa('#selTamanhos button').forEach(x => x.classList.remove('badge')); b.classList.add('badge');
        });
        tams.appendChild(b);
      });
      qs('#btnAddDetail').onclick = () => {
        const cor = (qsa('#selCores button.badge')[0]||{}).textContent || p.cores[0];
        const tam = (qsa('#selTamanhos button.badge')[0]||{}).textContent || p.tamanhos[0];
        addToCart(p.id, cor, tam, 1);
      };
    }

    // Favoritos
    async function loadFavoritos() {
      if (state.user && db) {
        // Carregar favoritos do usuário do Firestore
        try {
          const userFavs = await db.collection('usuarios').doc(state.user.uid).get();
          if (userFavs.exists) {
            state.favoritos = userFavs.data().favoritos || [];
          } else {
            state.favoritos = [];
          }
        } catch (error) {
          console.error('Erro ao carregar favoritos:', error);
          state.favoritos = [];
        }
      } else {
        // Fallback para localStorage se não estiver logado
        try { state.favoritos = JSON.parse(localStorage.getItem('tfi_favoritos')||'[]'); } catch { state.favoritos = []; }
      }
      updateFavoritosUI();
    }
    
    async function saveFavoritos() {
      if (state.user && db) {
        // Salvar favoritos do usuário no Firestore
        try {
          await db.collection('usuarios').doc(state.user.uid).set({
            favoritos: state.favoritos
          }, { merge: true });
        } catch (error) {
          console.error('Erro ao salvar favoritos:', error);
        }
      } else {
        // Fallback para localStorage se não estiver logado
        localStorage.setItem('tfi_favoritos', JSON.stringify(state.favoritos));
      }
      updateFavoritosUI();
    }
    
    async function toggleFavorito(id) {
      const index = state.favoritos.indexOf(id);
      if (index > -1) {
        state.favoritos.splice(index, 1);
      } else {
        state.favoritos.push(id);
      }
      await saveFavoritos();
    }
    function isFavorito(id) {
      return state.favoritos.includes(id);
    }
    function updateFavoritosUI() {
      // Atualizar botões de favorito em todos os cards
      qsa('.favorito-btn').forEach(btn => {
        const id = btn.getAttribute('data-id');
        const svg = btn.querySelector('svg');
        if (isFavorito(id)) {
          btn.classList.add('badge');
          svg.setAttribute('fill', 'currentColor');
        } else {
          btn.classList.remove('badge');
          svg.setAttribute('fill', 'none');
        }
      });
    }
    function renderFavoritos() {
      const grid = qs('#favoritosGrid');
      const vazio = qs('#favoritosVazio');
      
      // Verificar se usuário está logado
      if (!state.user) {
        grid.innerHTML = '';
        vazio.innerHTML = `
          <div class="text-6xl mb-4">🔒</div>
          <h3 class="text-xl font-bold mb-2">Faça login para ver seus favoritos</h3>
          <p class="text-slate-400 mb-6">Entre na sua conta para acessar seus produtos favoritos!</p>
          <button onclick="openLoginModal()" class="btn cta-gradient px-6 py-3 rounded-xl font-bold">Fazer Login</button>
        `;
        vazio.classList.remove('hidden');
        return;
      }
      
      if (state.favoritos.length === 0) {
        grid.innerHTML = '';
        vazio.innerHTML = `
          <div class="text-6xl mb-4">💔</div>
          <h3 class="text-xl font-bold mb-2">Nenhum favorito ainda</h3>
          <p class="text-slate-400 mb-6">Explore nossa loja e adicione produtos aos seus favoritos!</p>
          <a href="#loja" data-route class="btn cta-gradient px-6 py-3 rounded-xl font-bold">Explorar Loja</a>
        `;
        vazio.classList.remove('hidden');
        return;
      }
      
      vazio.classList.add('hidden');
      grid.innerHTML = '';
      
      state.favoritos.forEach(id => {
        const p = state.produtos.find(x => x.id === id);
        if (!p) return;
        
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl overflow-hidden hover:ring-2 hover:ring-emerald-400/40';
        el.innerHTML = `
          ${produtoThumb(p)}
          <div class="p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-bold">${p.nome}</h3>
              ${p.novas ? '<span class="badge px-2 py-1 rounded-full text-xs">Novo</span>' : ''}
            </div>
            <div class="mt-1 text-sm hint">${p.categoria}</div>
            <div class="mt-2 flex items-center gap-2">
              <div class="font-extrabold">${fmt(p.promo ?? p.preco)}</div>
              ${p.promo ? '<div class="line-through text-slate-400">'+fmt(p.preco)+'</div>' : ''}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn cta-gradient px-3 py-2 rounded-lg font-bold" data-id="${p.id}" data-action="ver">Ver</button>
              <button class="btn px-3 py-2 rounded-lg pill" data-id="${p.id}" data-action="add">Adicionar</button>
              <button class="btn px-3 py-2 rounded-lg pill favorito-btn" data-id="${p.id}" data-action="favoritar">
                <svg class="w-4 h-4" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });
      
      // Adicionar event listeners para os botões na página de favoritos
      grid.addEventListener('click', async e => {
        const b = e.target.closest('button'); if (!b) return;
        const id = b.getAttribute('data-id'); const act = b.getAttribute('data-action');
        if (act === 'ver') { openProduto(id); }
        if (act === 'add') { openTipoPecaModal(id); }
        if (act === 'favoritar') { await toggleFavorito(id); }
      });
    }

    // Carrinho
    function loadCart() {
      try { state.carrinho = JSON.parse(localStorage.getItem('tfi_cart')||'[]'); } catch { state.carrinho = []; }
      updateCartCount();
    }
    function saveCart() {
      localStorage.setItem('tfi_cart', JSON.stringify(state.carrinho));
      updateCartCount();
    }
    function updateCartCount() {
      qs('#cartCount').textContent = state.carrinho.reduce((s,i)=>s+i.qtd,0);
    }
    function addToCart(id, cor=null, tam=null, qtd=1) {
      const p = state.produtos.find(x=>x.id===id); if (!p) return;
      const key = id + '|' + (cor||p.cores[0]) + '|' + (tam||p.tamanhos[0]);
      const found = state.carrinho.find(x=>x.key===key);
      if (found) found.qtd += qtd;
      else state.carrinho.push({ key, id, nome: p.nome, preco: p.promo ?? p.preco, cor: cor||p.cores[0], tam: tam||p.tamanhos[0], qtd });
      saveCart();
      // toast simples
      const t = document.createElement('div');
      t.className='fixed bottom-6 right-6 glass rounded-xl p-3'; t.textContent='Adicionado ao carrinho';
      document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
    }
    function renderCarrinho() {
      const list = qs('#cartList'); list.innerHTML='';
      if (!state.carrinho.length){
        list.innerHTML = '<div class="glass rounded-xl p-5 text-slate-300">Seu carrinho está vazio.</div>';
      } else {
        state.carrinho.forEach((i, idx) => {
          const row = document.createElement('div');
          row.className = 'glass rounded-2xl p-4 flex items-center justify-between gap-3';
          row.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="card-img rounded-xl w-20 h-16 overflow-hidden bg-gray-800 flex-shrink-0">
                ${i.imagem ? 
                  `<img src="${i.imagem}" alt="${i.nome}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` :
                  ''
                }
                <div class="w-full h-full flex items-center justify-center text-gray-400" style="${i.imagem ? 'display:none;' : ''}">
                  📦
                </div>
              </div>
              <div>
                <div class="font-bold">${i.nome}</div>
                <div class="hint text-sm">Cor: ${i.cor} • Tam: ${i.tam}</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="pill px-2 py-1 rounded-lg">${fmt(i.preco)}</div>
              <div class="flex items-center gap-2">
                <button class="btn pill px-2 py-1 rounded-lg" data-idx="${idx}" data-act="menos">−</button>
                <div class="w-8 text-center">${i.qtd}</div>
                <button class="btn pill px-2 py-1 rounded-lg" data-idx="${idx}" data-act="mais">+</button>
              </div>
              <button class="btn px-3 py-2 rounded-lg pill" data-idx="${idx}" data-act="rm">Remover</button>
            </div>
          `;
          list.appendChild(row);
        });
        list.onclick = (e) => {
          const b = e.target.closest('button'); if(!b) return;
          const idx = +b.getAttribute('data-idx'); const act = b.getAttribute('data-act');
          if (act==='mais') state.carrinho[idx].qtd++;
          if (act==='menos') state.carrinho[idx].qtd = Math.max(1, state.carrinho[idx].qtd-1);
          if (act==='rm') state.carrinho.splice(idx,1);
          saveCart(); renderCarrinho();
        };
      }
      const subtotal = state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
      qs('#cartSubtotal').textContent = fmt(subtotal);
    }

    // Checkout
    function renderCheckoutResumo() {
      const box = qs('#resumoCheckout'); box.innerHTML='';
      if (!state.carrinho.length) {
        box.innerHTML = '<div class="hint">Seu carrinho está vazio.</div>';
      } else {
        state.carrinho.forEach(i => {
          const line = document.createElement('div');
          line.className = 'flex items-center justify-between';
          line.innerHTML = `<span class="text-slate-300">${i.nome} (${i.qtd})</span><span>${fmt(i.preco*i.qtd)}</span>`;
          box.appendChild(line);
        });
      }
      updateTotals();
    }
    function updateTotals() {
      const subtotal = state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0);
      const frete = state.freteSelecionado?.preco || 0;
      qs('#resFrete').textContent = fmt(frete);
      qs('#resTotal').textContent = fmt(subtotal + frete);
    }
        // Formatação automática do CEP
    const cepInput = qs('#cep');
    if (cepInput) {
      cepInput.addEventListener('input', (e) => {
      const cep = e.target.value.replace(/\D/g, '');
      if (cep.length <= 8) {
        e.target.value = superFreteService.formatCEP(cep);
      }
      
      // Limpar status quando usuário digita
        const cepStatus = qs('#cepStatus');
        if (cepStatus) {
          cepStatus.textContent = '';
        }
        const btnCalcFrete = qs('#btnCalcFrete');
        if (btnCalcFrete) {
          btnCalcFrete.disabled = true;
        }
      });
    }

    // Este código foi movido para initOtherEventListeners()

    // Este código foi movido para initOtherEventListeners()

    // Este código foi movido para initOtherEventListeners()

    // Pagamento
    // Event listeners para pagamento
    const btnPix = qs('#btnPix');
    if (btnPix) {
      btnPix.addEventListener('click', () => selectPaymentMethod('pix'));
    }
    
    const btnCartao = qs('#btnCartao');
    if (btnCartao) {
      btnCartao.addEventListener('click', () => selectPaymentMethod('card'));
    }
    
    const btnFecharPix = qs('#btnFecharPix');
    if (btnFecharPix) {
      btnFecharPix.addEventListener('click', closePixModal);
    }
    
    const btnFecharPix2 = qs('#btnFecharPix2');
    if (btnFecharPix2) {
      btnFecharPix2.addEventListener('click', closePixModal);
    }
    
    const btnVerificarPix = qs('#btnVerificarPix');
    if (btnVerificarPix) {
      btnVerificarPix.addEventListener('click', async () => {
        if (!currentPaymentId) return;
        
        try {
          const status = await asaasService.getPaymentStatus(currentPaymentId);
          if (status === 'CONFIRMED') {
            toast('Pagamento aprovado!');
            closePixModal();
            navigate('#home');
          } else {
            toast('Pagamento ainda não foi confirmado');
          }
        } catch (error) {
          console.error('Erro ao verificar PIX:', error);
          toast('Erro ao verificar pagamento');
        }
      });
    }
    
    const btnCopiarPix = qs('#btnCopiarPix');
    if (btnCopiarPix) {
      btnCopiarPix.addEventListener('click', () => {
        const pixCode = qs('#pixCode');
        if (pixCode && pixCode.value) {
          navigator.clipboard.writeText(pixCode.value).then(() => {
            toast('Código PIX copiado!');
          }).catch(() => {
            toast('Erro ao copiar código PIX');
          });
        }
      });
    }
    
    // Formatação de inputs
    const numeroCartao = qs('#numeroCartao');
    if (numeroCartao) {
      numeroCartao.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
        e.target.value = value;
      });
    }
    
    const validadeCartao = qs('#validadeCartao');
    if (validadeCartao) {
      validadeCartao.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
      });
    }
    
    const cvvCartao = qs('#cvvCartao');
    if (cvvCartao) {
      cvvCartao.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '');
      });
    }
    
    // Event listener para parcelamento
    const parcelasCartao = qs('#parcelasCartao');
    if (parcelasCartao) {
      parcelasCartao.addEventListener('change', updateParcelaInfo);
    }
    
    // Formatação de telefone
    const telefone = qs('#telefone');
    if (telefone) {
      telefone.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
          value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
          if (value.length < 14) {
            value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
          }
        }
        e.target.value = value;
      });
    }
    
    // Formatação de CPF
    const cpf = qs('#cpf');
    if (cpf) {
      cpf.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
          value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        e.target.value = value;
      });
    }

    const btnFinalizar = qs('#btnFinalizar');
    if (btnFinalizar) {
      btnFinalizar.addEventListener('click', async () => {
      await processPayment();
    });
    }
    
    const btnPagar = qs('#btnPagar');
    if (btnPagar) {
      btnPagar.addEventListener('click', async () => {
        await processPayment();
      });
    }

    // Funções de pagamento
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // Remover seleção anterior
      qsa('.payment-method-btn').forEach(btn => btn.classList.remove('selected'));
      
      // Adicionar seleção atual
      const selectedBtn = qs(`[data-method="${method}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('selected');
      }
      
      // Mostrar formulário de pagamento
      const paymentForm = qs('#paymentForm');
      if (paymentForm) {
        paymentForm.classList.remove('hidden');
      }
      
      // Mostrar formulário específico
      qsa('.payment-form').forEach(form => form.classList.add('hidden'));
      const specificForm = qs(`#${method}Form`);
      if (specificForm) {
        specificForm.classList.remove('hidden');
      }
      
      console.log('Método de pagamento selecionado:', method);
    }

    function validateCheckoutData() {
      const requiredFields = [
        { id: 'nome', name: 'Nome' },
        { id: 'email', name: 'Email' },
        { id: 'telefone', name: 'Telefone' },
        { id: 'cep', name: 'CEP' },
        { id: 'logradouro', name: 'Logradouro' },
        { id: 'numero', name: 'Número' },
        { id: 'bairro', name: 'Bairro' },
        { id: 'cidade', name: 'Cidade' },
        { id: 'uf', name: 'UF' }
      ];

      const errors = [];
      
      requiredFields.forEach(field => {
        const element = qs(`#${field.id}`);
        if (!element || !element.value.trim()) {
          errors.push(field.name);
        }
      });

      if (errors.length > 0) {
        toast(`Preencha os campos obrigatórios: ${errors.join(', ')}`);
        return false;
      }

      if (!selectedPaymentMethod) {
        toast('Selecione uma forma de pagamento');
        return false;
      }

      if (selectedPaymentMethod === 'card') {
        const cardFields = [
          { id: 'numeroCartao', name: 'Número do cartão' },
          { id: 'validadeCartao', name: 'Validade' },
          { id: 'nomeCartao', name: 'Nome no cartão' },
          { id: 'cvvCartao', name: 'CVV' }
        ];

        cardFields.forEach(field => {
          const element = qs(`#${field.id}`);
          if (!element || !element.value.trim()) {
            errors.push(field.name);
          }
        });

        if (errors.length > 0) {
          toast(`Preencha os dados do cartão: ${errors.join(', ')}`);
          return false;
        }
      }

      return true;
    }

    async function processPixPayment(orderData) {
      try {
        console.log('🔄 Processando pagamento PIX...');
        
        const paymentData = {
          items: orderData.items.map(item => ({
            id: item.id,
            nome: item.nome,
            descricao: `${item.cor} - ${item.tamanho}`,
            quantidade: item.quantidade,
            preco: item.preco
          })),
          customer: {
            nome: qs('#nome')?.value || 'Cliente Teste',
            email: qs('#email')?.value || 'teste@teste.com',
            telefone: qs('#telefone')?.value || '11999999999',
            cpf: qs('#cpf')?.value || '12345678901',
            cep: qs('#cep')?.value || '01234567',
            endereco: qs('#logradouro')?.value || 'Rua Teste',
            numero: qs('#numero')?.value || '123',
            complemento: qs('#complemento')?.value || '',
            bairro: qs('#bairro')?.value || 'Centro',
            cidade: qs('#cidade')?.value || 'São Paulo',
            estado: qs('#uf')?.value || 'SP'
          },
          external_reference: `TFI-${Date.now()}`,
          user_id: orderData.user_id,
          total: orderData.total || (orderData.subtotal + (orderData.shipping?.price || 0))
        };

        console.log('📦 Dados para pagamento PIX:', paymentData);
        
        // Verificar se o serviço está disponível
        if (typeof asaasService === 'undefined') {
          console.error('❌ AsaasService não está disponível');
          toast('Erro: Serviço de pagamento não disponível');
        return;
      }
      
        const paymentResult = await asaasService.createPixPayment(paymentData);
        
        console.log('🔄 Resultado da criação do pagamento PIX:', paymentResult);
        
        if (paymentResult.success) {
          currentPaymentId = paymentResult.paymentId;
          
          // Mostrar modal PIX com QR Code para pagamento
          showPixModal(paymentResult);
          
          // Salvar pedido no Firebase com status pendente
          const orderRef = await db.collection('pedidos').add({
            ...orderData,
            status: 'pending_payment',
            payment_id: paymentResult.paymentId,
            payment_method: 'pix',
            external_reference: paymentData.external_reference,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          
          // Mostrar modal PIX
          showPixModal(paymentResult);
          
        } else {
          console.error('❌ Erro ao criar pagamento PIX:', paymentResult.error);
          toast(`Erro ao criar pagamento PIX: ${paymentResult.error}`);
        }
        
      } catch (error) {
        console.error('❌ Erro no processamento PIX:', error);
        toast('Erro ao processar pagamento PIX. Tente novamente.');
      }
    }

    // Função para atualizar informações de parcelamento
    function updateParcelaInfo() {
      const parcelas = parseInt(qs('#parcelasCartao').value);
      const parcelaInfo = qs('#parcelaInfo');
      const total = state.carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
      const frete = state.shipping?.price || 0;
      const totalComFrete = total + frete;
      
      if (parcelas === 1) {
        parcelaInfo.textContent = `Total: R$ ${totalComFrete.toFixed(2).replace('.', ',')}`;
      } else if (parcelas <= 6) {
        const valorParcela = totalComFrete / parcelas;
        parcelaInfo.textContent = `${parcelas}x de R$ ${valorParcela.toFixed(2).replace('.', ',')} sem juros`;
      } else {
        // Aplicar juros de 2.99% ao mês para parcelas acima de 6x
        const taxaJuros = 0.0299;
        const valorComJuros = totalComFrete * Math.pow(1 + taxaJuros, parcelas - 6);
        const valorParcela = valorComJuros / parcelas;
        parcelaInfo.textContent = `${parcelas}x de R$ ${valorParcela.toFixed(2).replace('.', ',')} com juros`;
      }
    }

    async function processCardPayment(orderData) {
      try {
        console.log('🔄 Processando pagamento com cartão...');
        
        const parcelas = parseInt(qs('#parcelasCartao').value);
        const cardData = {
          numero: qs('#numeroCartao').value.replace(/\D/g, ''),
          validade: qs('#validadeCartao').value,
          nome: qs('#nomeCartao').value,
          cvv: qs('#cvvCartao').value,
          parcelas: parcelas
        };

        const paymentData = {
          items: orderData.items.map(item => ({
            id: item.id,
            nome: item.nome,
            descricao: `${item.cor} - ${item.tamanho}`,
            quantidade: item.quantidade,
            preco: item.preco
          })),
          customer: {
            nome: qs('#nome')?.value || 'Cliente Teste',
            email: qs('#email')?.value || 'teste@teste.com',
            telefone: qs('#telefone')?.value || '11999999999',
            cpf: qs('#cpf')?.value || '12345678901',
            cep: qs('#cep')?.value || '01234567',
            endereco: qs('#logradouro')?.value || 'Rua Teste',
            numero: qs('#numero')?.value || '123',
            complemento: qs('#complemento')?.value || '',
            bairro: qs('#bairro')?.value || 'Centro',
            cidade: qs('#cidade')?.value || 'São Paulo',
            estado: qs('#uf')?.value || 'SP'
          },
          card: cardData,
          external_reference: `TFI-${Date.now()}`,
          user_id: orderData.user_id,
          total: orderData.total || (orderData.subtotal + (orderData.shipping?.price || 0))
        };

        console.log('📦 Dados para pagamento com cartão:', paymentData);
        
        // Verificar se o serviço está disponível
        if (typeof asaasService === 'undefined') {
          console.error('❌ AsaasService não está disponível');
          toast('Erro: Serviço de pagamento não disponível');
          return;
        }
        
        const paymentResult = await asaasService.createCardPayment(paymentData);
        
        console.log('🔄 Resultado da criação do pagamento com cartão:', paymentResult);
        
        if (paymentResult.success) {
          currentPaymentId = paymentResult.paymentId;
          
          // Preparar dados do pedido para salvar
          const orderToSave = {
            ...orderData,
            paymentId: paymentResult.paymentId,
            paymentMethod: 'card',
            status: paymentResult.status === 'CONFIRMED' ? 'confirmed' : 'pending',
            external_reference: paymentData.external_reference,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          
          // Salvar pedido no Firebase
          try {
            await saveOrderToFirebase(orderToSave);
          } catch (error) {
            console.error('❌ Erro ao salvar pedido:', error);
          }
          
          // Sempre mostrar modal de confirmação para pagamentos por cartão
          toast('Pagamento processado com sucesso!');
          
          // Mostrar modal de confirmação imediatamente
          showConfirmacaoModal(orderToSave, paymentResult);
          
        // Limpar carrinho
        if (typeof state !== 'undefined') {
          state.carrinho = [];
          saveCart();
          updateCartCount();
        }
          
          // Iniciar verificação automática do status em background
          console.log('🔄 Iniciando verificação em background...');
          startCardVerification(paymentResult.paymentId, orderToSave);
          
        } else {
          console.error('❌ Erro ao criar pagamento com cartão:', paymentResult.error);
          
          // Verificar se é erro de cartão recusado
          if (paymentResult.error && paymentResult.error.includes('não autorizada')) {
            console.log('💳 Cartão recusado - mostrando modal de confirmação');
            
            // Mostrar modal de confirmação com mensagem de cartão recusado
            showConfirmacaoModal({
              success: false,
              message: 'Cartão de crédito recusado',
              details: 'A transação não foi autorizada. Verifique os dados do cartão e tente novamente.',
              orderData: orderData
            });
          } else {
            toast(`Erro ao processar cartão: ${paymentResult.error}`);
          }
        }
        
      } catch (error) {
        console.error('❌ Erro no processamento com cartão:', error);
        toast('Erro ao processar pagamento com cartão. Tente novamente.');
      }
    }

    function showPixModal(paymentResult) {
      console.log('🔄 Exibindo modal PIX:', paymentResult);
      console.log('🔍 QR Code:', paymentResult.qrCode);
      console.log('🔍 PIX Copy Paste:', paymentResult.pixCopyPaste);
      const modal = qs('#pixModal');
      if (!modal) {
        console.error('❌ Modal PIX não encontrada');
        return;
      }

      // Gerar QR Code
      const qrCodeDiv = qs('#pixQrCode');
      if (qrCodeDiv) {
        const qrCodeImage = paymentResult.qrCode;
        const pixKey = paymentResult.pixKey || 'Chave PIX não disponível';
        
        if (qrCodeImage) {
          // Mostrar QR Code como imagem
          qrCodeDiv.innerHTML = `
            <div class="text-center p-4">
              <div class="bg-white p-4 rounded-lg mb-4">
                <div class="text-sm text-gray-600 mb-2">QR Code PIX</div>
                <img src="data:image/png;base64,${qrCodeImage}" alt="QR Code PIX" class="mx-auto mb-2" style="max-width: 200px; height: auto;" />
                <div class="text-xs text-gray-400">Chave: ${pixKey}</div>
              </div>
              <div class="text-xs text-slate-400">
                Escaneie o QR Code com seu app de pagamento
              </div>
            </div>
          `;
        } else {
          // Mostrar mensagem de erro
          qrCodeDiv.innerHTML = `
            <div class="text-center p-4">
              <div class="bg-white p-4 rounded-lg mb-4">
                <div class="text-6xl mb-2">❌</div>
                <div class="text-sm text-gray-600 mb-2">QR Code não disponível</div>
                <div class="text-xs text-gray-500">Erro: ${paymentResult.error || 'QR Code não foi gerado'}</div>
              </div>
              <div class="text-xs text-slate-400">
                Use o código PIX abaixo para pagar
              </div>
            </div>
          `;
        }
      }

      // Preencher código PIX
      const pixCodeInput = qs('#pixCode');
      if (pixCodeInput) {
        const pixCode = paymentResult.pixCopyPaste || paymentResult.rawData?.pixTransaction?.payload || 'Código PIX não disponível';
        pixCodeInput.value = pixCode;
        pixCodeInput.disabled = false;
      }

      // Mostrar modal
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // Iniciar verificação automática
      startPixVerification();
    }

    function startPixVerification() {
      if (pixVerificationInterval) {
        clearInterval(pixVerificationInterval);
      }

      console.log('🔄 Iniciando verificação automática do PIX:', currentPaymentId);
      
      // Atualizar status inicial
      updatePixStatus('Aguardando pagamento...', 'pending');

      pixVerificationInterval = setInterval(async () => {
        if (!currentPaymentId) return;

        try {
          console.log('🔍 Verificando status do pagamento:', currentPaymentId);
          const statusResult = await asaasService.getPaymentStatus(currentPaymentId);
          console.log('📊 Status do pagamento:', statusResult);
          
          if (statusResult.success) {
            const status = statusResult.status;
            
            if (status === 'CONFIRMED' || status === 'RECEIVED_IN_CASH') {
              // Pagamento confirmado!
              console.log('✅ Pagamento confirmado!');
              clearInterval(pixVerificationInterval);
              pixVerificationInterval = null;
              
              // Atualizar status no modal
              updatePixStatus('Pagamento aprovado! ✅', 'success');
              
              toast('Pagamento aprovado! Pedido confirmado.');
              
              // Preparar dados do pedido para modal de confirmação
              const orderData = {
                items: state.carrinho.map(item => ({
            id: item.id,
            nome: item.nome,
            preco: item.preco,
                  quantidade: item.qtd,
            cor: item.cor,
                  tamanho: item.tam
                })),
                user_id: state.user?.uid,
                user_email: state.user?.email,
                user_name: state.user?.displayName || 'Usuário',
                user_phone: qs('#telefone')?.value || 'N/A',
                paymentId: currentPaymentId,
                paymentMethod: 'pix',
                status: 'confirmed',
                confirmedAt: new Date().toISOString()
              };
              
              // Salvar pedido no Firebase
              await saveOrderToFirebase(orderData);
              
              // Fechar modal PIX e mostrar modal de confirmação
              setTimeout(() => {
                closePixModal();
                showConfirmacaoModal(orderData, { success: true, paymentId: currentPaymentId });
              }, 2000);
              
            } else if (status === 'PENDING') {
              // Ainda aguardando
              updatePixStatus('Aguardando pagamento...', 'pending');
              
            } else if (status === 'OVERDUE' || status === 'CANCELLED') {
              // Pagamento cancelado/vencido
              console.log('❌ Pagamento cancelado/vencido');
              clearInterval(pixVerificationInterval);
              pixVerificationInterval = null;
              updatePixStatus('Pagamento cancelado/vencido ❌', 'error');
              
            } else {
              // Outros status
              updatePixStatus(`Status: ${status}`, 'pending');
            }
          } else {
            console.error('❌ Erro ao verificar status:', statusResult.error);
            updatePixStatus('Erro ao verificar pagamento', 'error');
          }
        } catch (error) {
          console.error('❌ Erro na verificação automática:', error);
          updatePixStatus('Erro na verificação', 'error');
        }
      }, 3000); // Verificar a cada 3 segundos
      
      // Parar verificação após 10 minutos (timeout)
      setTimeout(() => {
        if (pixVerificationInterval) {
          clearInterval(pixVerificationInterval);
          pixVerificationInterval = null;
          console.log('⏰ Timeout da verificação automática');
          updatePixStatus('Tempo limite atingido', 'timeout');
        }
      }, 600000); // 10 minutos
    }

    // Função para atualizar status na modal PIX
    function updatePixStatus(message, status) {
      const statusDiv = qs('#pixStatus');
      if (statusDiv) {
        if (status === 'success') {
          statusDiv.innerHTML = `
            <div class="flex items-center justify-center gap-2 text-green-400">
              <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
              <span class="text-sm">${message}</span>
            </div>
          `;
        } else if (status === 'error' || status === 'timeout') {
          statusDiv.innerHTML = `
            <div class="flex items-center justify-center gap-2 text-red-400">
              <div class="w-3 h-3 bg-red-400 rounded-full"></div>
              <span class="text-sm">${message}</span>
            </div>
          `;
        } else {
          statusDiv.innerHTML = `
            <div class="flex items-center justify-center gap-2 text-blue-400">
              <div class="w-3 h-3 bg-blue-400 rounded-full animate-pulse"></div>
              <span class="text-sm">${message}</span>
            </div>
          `;
        }
      }
    }

    // Função para salvar pedido no Firebase
    async function saveOrderToFirebase(orderData) {
      try {
        console.log('💾 Salvando pedido no Firebase:', orderData);
        
        // Adicionar timestamp e ID único
        const orderId = `order_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const orderWithId = {
          ...orderData,
          id: orderId,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // Salvar no Firestore
        await db.collection('orders').doc(orderId).set(orderWithId);
        
        console.log('✅ Pedido salvo no Firebase com ID:', orderId);
        
        // Criar etiqueta de envio se frete foi selecionado
        if (state.freteSelecionado) {
          try {
            console.log('🏷️ Criando etiqueta de envio...');
            
            const shippingData = {
              service_id: state.freteSelecionado.id,
              cliente: {
                nome: orderData.user_name,
                telefone: orderData.user_phone,
                email: orderData.user_email,
                documento: orderData.user_document
              },
          endereco: {
                logradouro: orderData.shipping_address.street,
                complemento: orderData.shipping_address.complement,
                numero: orderData.shipping_address.number,
                bairro: orderData.shipping_address.district,
                cidade: orderData.shipping_address.city,
                uf: orderData.shipping_address.state,
                cep: orderData.shipping_address.zipcode
              },
              produtos: orderData.items.map(item => ({
                nome: item.name,
                quantidade: item.quantity,
                preco: item.price
              })),
              peso_total: orderData.items.reduce((total, item) => total + (0.3 * item.quantity), 0)
            };
            
            // Simular criação de etiqueta (sem Super Frete)
            const labelResult = { success: true, tracking_code: 'TRK' + Date.now() };
            
            if (labelResult.success) {
              console.log('✅ Etiqueta criada:', labelResult);
              
              // Atualizar pedido com dados da etiqueta
              await db.collection('orders').doc(orderId).update({
                'shipping_label': {
                  order_id: orderId, // Usar o ID do pedido
                  protocol: labelResult.protocol || 'N/A',
                  tracking_code: labelResult.tracking_code,
                  status: 'created',
                  created_at: new Date(),
                  fallback: labelResult.fallback || false
                },
                updated_at: new Date()
              });
              
              console.log('✅ Pedido atualizado com dados da etiqueta');
            } else {
              console.error('❌ Erro ao criar etiqueta:', labelResult.error);
            }
          } catch (error) {
            console.error('❌ Erro ao criar etiqueta de envio:', error);
          }
        }
        
        // Limpar carrinho após salvar
        state.carrinho = []; 
        saveCart(); 
        updateCartCount();
        
        return orderWithId;
      } catch (error) {
        console.error('❌ Erro ao salvar pedido no Firebase:', error);
        throw error;
      }
    }

    // Função para verificação automática de pagamento por cartão
    function startCardVerification(paymentId, orderData) {
      console.log('🔄 Iniciando verificação automática do cartão:', paymentId);
      
      let verificationAttempts = 0;
      const maxAttempts = 20; // 20 tentativas (1 minuto)
      
      const verificationInterval = setInterval(async () => {
        verificationAttempts++;
        
        if (verificationAttempts > maxAttempts) {
          clearInterval(verificationInterval);
          console.log('⏰ Timeout da verificação do cartão');
          toast('Tempo limite atingido. Verifique o status do pagamento.');
          return;
        }
        
        try {
          console.log(`🔍 Verificando status do cartão (tentativa ${verificationAttempts}/${maxAttempts}):`, paymentId);
          
          const statusResult = await asaasService.getPaymentStatus(paymentId);
          console.log('📊 Status do cartão:', statusResult);
          
          if (statusResult.success) {
            const status = statusResult.status;
            
            if (status === 'CONFIRMED' || status === 'RECEIVED_IN_CASH') {
              // Pagamento confirmado!
              console.log('✅ Pagamento por cartão confirmado!');
              clearInterval(verificationInterval);
              
              // Atualizar status do pedido
              orderData.status = 'confirmed';
              orderData.confirmedAt = new Date().toISOString();
              
              // Atualizar no Firebase
              try {
                await db.collection('orders').doc(orderData.id).update({
                  status: 'confirmed',
                  confirmedAt: orderData.confirmedAt,
                  updatedAt: new Date().toISOString()
                });
                console.log('✅ Status do pedido atualizado no Firebase');
              } catch (error) {
                console.error('❌ Erro ao atualizar pedido:', error);
              }
              
              toast('Pagamento confirmado! Pedido aprovado.');
              
              // Não mostrar modal novamente, apenas atualizar status
              console.log('✅ Status do pagamento atualizado para confirmado');
              
            } else if (status === 'PENDING') {
              // Ainda aguardando
              console.log('⏳ Pagamento ainda pendente...');
              
            } else if (status === 'OVERDUE' || status === 'CANCELLED') {
              // Pagamento cancelado/vencido
              console.log('❌ Pagamento cancelado/vencido');
              clearInterval(verificationInterval);
              toast('Pagamento cancelado ou vencido.');
              
            } else {
              // Outros status
              console.log(`📊 Status: ${status}`);
            }
          } else {
            console.error('❌ Erro ao verificar status:', statusResult.error);
          }
          
        } catch (error) {
          console.error('❌ Erro na verificação do cartão:', error);
        }
      }, 3000); // Verificar a cada 3 segundos
    }

    function closePixModal() {
      const modal = qs('#pixModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      
      if (pixVerificationInterval) {
        clearInterval(pixVerificationInterval);
        pixVerificationInterval = null;
      }
    }

    // Processar pagamento
    async function processPayment() {
      if (!state.carrinho.length) {
        toast('Adicione produtos antes de finalizar.');
        return;
      }
      
      if (!state.user) {
        toast('Faça login para finalizar o pedido.');
        openLoginModal();
        return;
      }
      
      if (!state.freteSelecionado) {
        toast('Selecione uma opção de frete.');
        return;
      }
      
      // Validar dados do checkout
      if (!validateCheckoutData()) {
        return;
      }
      
      try {
        console.log('🔍 Iniciando processamento de pagamento...');
        
        // Validar configuração das APIs
        const configValidation = validateConfig();
        console.log('🔍 Resultado da validação:', configValidation);
        
        if (!configValidation.isValid) {
          console.error('❌ Configuração inválida:', configValidation.errors);
          toast('Sistema de pagamento em configuração. Verifique as credenciais.');
          return;
        }
        
        console.log('✅ Configuração válida, continuando...');
        
        // Preparar dados do pedido
        const orderData = {
          user_id: state.user.uid,
          user_email: state.user.email,
          user_name: state.user.displayName || 'Usuário',
          user_phone: qs('#telefone').value,
          items: state.carrinho.map(item => ({
            id: item.id,
            nome: item.nome,
            preco: item.preco,
            quantidade: item.qtd,
            cor: item.cor,
            tamanho: item.tam
          })),
          subtotal: state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0),
          shipping: {
            service_id: state.freteSelecionado.id,
            company_id: state.freteSelecionado.company_id,
            price: state.freteSelecionado.preco,
            name: state.freteSelecionado.nome,
            delivery_time: state.freteSelecionado.prazo
          },
          total: state.carrinho.reduce((s,i)=>s+i.preco*i.qtd,0) + (state.freteSelecionado?.preco || 0),
          shipping_address: state.enderecoCompleto || {
            cep: qs('#cep').value.replace(/\D/g, ''),
            logradouro: qs('#logradouro').value,
            bairro: qs('#bairro').value,
            cidade: qs('#cidade').value,
            uf: qs('#uf').value,
            numero: qs('#numero').value,
            complemento: qs('#complemento').value
          },
          payment_method: 'asaas',
          payment_data: {}
        };
        
        console.log('📦 Dados do pedido preparados:', orderData);
        
        // Processar pagamento baseado no método selecionado
        if (selectedPaymentMethod === 'pix') {
          await processPixPayment(orderData);
        } else if (selectedPaymentMethod === 'card') {
          await processCardPayment(orderData);
        } else {
          toast('Método de pagamento não selecionado');
        }
        
      } catch (error) {
        console.error('❌ Erro ao processar pagamento:', error);
        console.error('❌ Stack trace:', error.stack);
        toast('Erro ao processar pagamento. Tente novamente.');
      }
    }
    


    function toast(msg, type = 'info') {
      const t = document.createElement('div');
      let bgClass = 'glass';
      let icon = '';
      
      switch(type) {
        case 'success':
          bgClass = 'bg-green-600/90 border-green-500';
          icon = '✅ ';
          break;
        case 'error':
          bgClass = 'bg-red-600/90 border-red-500';
          icon = '❌ ';
          break;
        case 'warning':
          bgClass = 'bg-yellow-600/90 border-yellow-500';
          icon = '⚠️ ';
          break;
        default:
          bgClass = 'glass';
          icon = '';
      }
      
      t.className = `fixed bottom-6 left-1/2 -translate-x-1/2 ${bgClass} border rounded-xl px-4 py-3 text-white font-medium shadow-lg z-50`;
      t.textContent = icon + msg; 
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), type === 'success' ? 4000 : 3000);
    }

    // Renderizar área "Minha Conta"
    async function renderMinhaConta() {
      if (!state.user) return;
      
      // Atualizar informações do usuário
      qs('#userName').textContent = state.user.displayName || 'Usuário';
      qs('#userEmail').textContent = state.user.email;
      qs('#userSince').textContent = state.user.metadata?.creationTime ? 
        new Date(state.user.metadata.creationTime).toLocaleDateString('pt-BR') : 'Data não disponível';
      qs('#userWelcome').textContent = `Olá, ${state.user.displayName || 'Usuário'}!`;
      
      // Carregar pedidos do usuário e estatísticas
      await loadUserOrders();
      await loadUserStats();
      
      // Carregar favoritos (implementar depois se necessário)
      renderUserFavorites();
    }
    
    // Carregar estatísticas do usuário
    async function loadUserStats() {
      try {
        if (!db || !state.user) return;
        
        const snapshot = await db.collection('orders')
          .where('user_id', '==', state.user.uid)
          .get();
        
        const orders = [];
        snapshot.forEach(doc => {
          orders.push(doc.data());
        });
        
        // Calcular estatísticas
        const totalOrders = orders.length;
        const totalSpent = orders.reduce((sum, order) => {
          // Calcular total dos itens
          const itemsTotal = order.items?.reduce((itemSum, item) => itemSum + (item.preco * item.quantidade), 0) || 0;
          return sum + itemsTotal;
        }, 0);
        const lastOrder = orders.length > 0 ? 
          orders.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))[0] : null;
        
        // Atualizar interface
        qs('#totalOrders').textContent = totalOrders;
        qs('#totalSpent').textContent = fmt(totalSpent);
        qs('#lastOrder').textContent = lastOrder ? 
          new Date(lastOrder.createdAt).toLocaleDateString('pt-BR') : 
          'Nenhum pedido';
        
      } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
        qs('#totalOrders').textContent = '0';
        qs('#totalSpent').textContent = 'R$ 0,00';
        qs('#lastOrder').textContent = '-';
      }
    }
    
    // Carregar pedidos do usuário
    async function loadUserOrders() {
      try {
        if (!db || !state.user) return;
        
        console.log('🔍 Carregando pedidos do usuário:', state.user.uid);
        
        // Consulta simplificada para evitar necessidade de índice composto
        const snapshot = await db.collection('orders')
          .where('user_id', '==', state.user.uid)
          .limit(10)
          .get();
        
        const ordersContainer = qs('#userOrders');
        ordersContainer.innerHTML = '';
        
        if (snapshot.empty) {
          ordersContainer.innerHTML = '<div class="text-slate-300 text-center py-4">Nenhum pedido encontrado</div>';
          return;
        }
        
        // Ordenar manualmente por data de criação (mais recente primeiro)
        const orders = [];
        snapshot.forEach(doc => {
          orders.push({ id: doc.id, ...doc.data() });
        });
        
        orders.sort((a, b) => {
          const dateA = new Date(a.createdAt || 0);
          const dateB = new Date(b.createdAt || 0);
          return dateB - dateA; // Mais recente primeiro
        });
        
        orders.forEach(order => {
          console.log('📦 Pedido encontrado:', order);
          
          const orderDate = order.createdAt ? 
            new Date(order.createdAt).toLocaleDateString('pt-BR') : 
            'Data não disponível';
          
          // Calcular total dos itens
          const totalItems = order.items?.reduce((sum, item) => sum + (item.preco * item.quantidade), 0) || 0;
          
          const orderEl = document.createElement('div');
          orderEl.className = 'glass rounded-xl p-4 mb-3';
          orderEl.innerHTML = `
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="font-bold text-lg">Pedido #${order.id.slice(-6)}</div>
                <div class="text-sm text-slate-300">${orderDate}</div>
              </div>
              <div class="text-right">
                <div class="font-bold text-lg">${fmt(totalItems)}</div>
                <div class="text-sm badge px-2 py-1 rounded-full mt-1 ${order.status === 'confirmed' ? 'bg-green-500' : 'bg-yellow-500'}">${order.status === 'confirmed' ? 'Confirmado' : 'Pendente'}</div>
              </div>
            </div>
            
            <div class="space-y-2">
              <div class="text-sm text-slate-300">
                <strong>Itens:</strong> ${order.items?.length || 0} produto(s)
              </div>
                <div class="text-sm text-slate-300">
                <strong>Método:</strong> ${order.paymentMethod === 'pix' ? 'PIX' : 'Cartão'}
                </div>
              ${order.user_phone ? `
                <div class="text-sm text-slate-300">
                  <strong>Contato:</strong> ${order.user_phone}
                </div>
              ` : ''}
            </div>
            
            <div class="mt-3 pt-3 border-t border-white/10">
              <div class="text-xs text-slate-400">
                Total: ${fmt(totalItems)} | 
                Status: ${order.status === 'confirmed' ? 'Confirmado' : 'Pendente'}
              </div>
            </div>
          `;
          ordersContainer.appendChild(orderEl);
        });
        
      } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        qs('#userOrders').innerHTML = '<div class="text-slate-300 text-center py-4">Erro ao carregar pedidos</div>';
      }
    }
    
    // Renderizar favoritos do usuário
    function renderUserFavorites() {
      const favoritesContainer = qs('#userFavorites');
      
      if (!state.user) {
        favoritesContainer.innerHTML = '<div class="text-slate-300 text-center py-8">Faça login para ver seus favoritos</div>';
        return;
      }
      
      if (state.favoritos.length === 0) {
        favoritesContainer.innerHTML = `
          <div class="text-slate-300 text-center py-8">
            <div class="text-4xl mb-2">❤️</div>
            <div class="text-lg font-bold mb-1">Nenhum favorito ainda</div>
            <div class="text-sm">Adicione produtos aos favoritos para vê-los aqui</div>
          </div>
        `;
        return;
      }
      
      // Mostrar favoritos do usuário
      favoritesContainer.innerHTML = '';
      state.favoritos.slice(0, 8).forEach(id => {
        const p = state.produtos.find(x => x.id === id);
        if (!p) return;
        
        const favEl = document.createElement('div');
        favEl.className = 'glass rounded-xl p-3 hover:ring-2 hover:ring-emerald-400/40 cursor-pointer';
        favEl.onclick = () => openProduto(p.id);
        favEl.innerHTML = `
          <div class="aspect-square rounded-lg overflow-hidden mb-2">
            <img src="${p.imagens[0]}" alt="${p.nome}" class="w-full h-full object-cover">
          </div>
          <div class="text-sm font-bold truncate">${p.nome}</div>
          <div class="text-emerald-400 font-bold">${fmt(p.preco)}</div>
        `;
        favoritesContainer.appendChild(favEl);
      });
      
      if (state.favoritos.length > 8) {
        const moreEl = document.createElement('div');
        moreEl.className = 'text-center py-4';
        moreEl.innerHTML = `
          <a href="#favoritos" data-route class="btn pill px-4 py-2 text-sm">
            Ver todos os ${state.favoritos.length} favoritos
          </a>
        `;
        favoritesContainer.appendChild(moreEl);
      }
    }

    // Feedbacks
    const feedbacks = [];
    function renderFeedbacks() {
      const list = qs('#feedbackList'); list.innerHTML='';
      feedbacks.forEach(f => {
        const el = document.createElement('div');
        el.className = 'glass rounded-2xl p-4';
        el.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-bold">${f.nome}</div>
            <div class="text-sm hint">${f.data}</div>
          </div>
          <div class="mt-1 star">${'★'.repeat(f.nota)}<span class="text-slate-600">${'★'.repeat(5-f.nota)}</span></div>
          <p class="mt-2 text-slate-300">${f.texto}</p>
        `;
        list.appendChild(el);
      });
    }
    // estrelas input
    let currentRating = 5;
    function initRating() {
      const box = qs('#ratingStars'); box.innerHTML='';
      for (let i=1;i<=5;i++){
        const b = document.createElement('button');
        b.className = 'text-2xl'; b.textContent = '★';
        b.style.color = (i<=currentRating)?'#ffd166':'#334155';
        b.addEventListener('click', ()=>{
          currentRating = i;
          qsa('#ratingStars button').forEach((x,idx)=> x.style.color = (idx < i)?'#ffd166':'#334155');
        });
        box.appendChild(b);
      }
      qs('#btnEnviarFeedback').onclick = async () => {
        // Verificar rate limiting
        if (!checkRateLimit('feedback', 3, 300000)) { // 3 tentativas por 5 minutos
          toast('Muitas tentativas. Aguarde 5 minutos.');
          return;
        }
        
        const txt = qs('#feedbackText').value.trim();
        if (!txt) { toast('Escreva um comentário.'); return; }
        
        // Sanitizar dados
        const sanitizedText = sanitizeText(txt);
        const sanitizedName = sanitizeText(state.user?.displayName || 'Cliente');
        
        if (sanitizedText.length < 3) {
          toast('Comentário muito curto.');
          return;
        }
        
        try {
          // Salvar no Firestore
          const feedbackData = {
            nome: sanitizedName,
            nota: currentRating,
            texto: sanitizedText,
            data: new Date().toLocaleDateString('pt-BR'),
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            userId: state.user?.uid || null
          };
          
          await db.collection('feedbacks').add(feedbackData);
          
          // Adicionar ao estado local
        feedbacks.unshift({ 
          nome: sanitizedName, 
          nota: currentRating, 
          texto: sanitizedText, 
          data: 'agora' 
        });
          
        qs('#feedbackText').value='';
        renderFeedbacks();
        
        // Atualizar contador de feedbacks
        await updateFeedbackCount();
        
        toast('Obrigado pelo feedback!');
          
        } catch (error) {
          console.error('Erro ao salvar feedback:', error);
          toast('Erro ao enviar feedback. Tente novamente.');
        }
      };
    }

    // Chat simples
    const chatMsgs = [];
    function renderChat() {
      const box = qs('#chatBox');
      box.innerHTML = chatMsgs.map(m => `
        <div class="flex ${m.me?'justify-end':'justify-start'}">
          <div class="max-w-[80%] ${m.me?'cta-gradient':'glass'} rounded-xl px-3 py-2 my-1">${m.txt}</div>
        </div>
      `).join('');
      box.scrollTop = box.scrollHeight;
    }
    qs('#btnChat').addEventListener('click', async () => {
      const input = qs('#chatInput'); const txt = input.value.trim();
      if (!txt) return;
      
      try {
        // Salvar mensagem no Firestore
        const mensagemData = {
          texto: sanitizeText(txt),
          remetente: 'cliente',
          userId: state.user?.uid || null,
          email: state.user?.email || null,
          criadoEm: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('mensagens').add(mensagemData);
        
        chatMsgs.push({ me:true, txt }); 
        input.value='';
      renderChat();
        
        setTimeout(()=>{ 
          chatMsgs.push({ me:false, txt:'Recebido! Nossa equipe retornará em breve.' }); 
          renderChat(); 
        }, 700);
        
      } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        toast('Erro ao enviar mensagem. Tente novamente.');
      }
    });

    // Admin: inserir produto local
    function adminFillCategorias() {
      const sel = qs('#admCategoria'); 
      sel.innerHTML='';
      state.categorias.forEach(c=>{
        const o=document.createElement('option'); 
        o.value=c; 
        o.textContent=c; 
        sel.appendChild(o);
      });
    }

    // Função para adicionar campo de imagem
    function addImagemField() {
      const container = qs('#imagensContainer');
      const inputCount = container.querySelectorAll('.imagem-input').length;
      const newInput = document.createElement('div');
      newInput.className = 'flex items-center gap-2';
      newInput.innerHTML = `
        <input type="text" class="imagem-input bg-transparent pill px-3 py-2 rounded-lg flex-1" placeholder="URL da imagem ${inputCount + 1}" />
        <button type="button" class="remove-imagem-btn text-red-400 hover:text-red-300 p-1" title="Remover imagem">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;
      container.appendChild(newInput);
      
      // Adicionar event listener para remover
      newInput.querySelector('.remove-imagem-btn').addEventListener('click', () => {
        newInput.remove();
      });
    }

    // Função para obter todas as imagens
    function getImagens() {
      const container = qs('#imagensContainer');
      if (!container) return [];
      
      const inputs = container.querySelectorAll('.imagem-input');
      return Array.from(inputs)
        .map(input => input.value.trim())
        .filter(url => url.length > 0);
    }

    // Função para definir imagens (para edição)
    function setImagens(imagens) {
      const container = qs('#imagensContainer');
      container.innerHTML = '';
      
      if (imagens && imagens.length > 0) {
        imagens.forEach((url, index) => {
          const div = document.createElement('div');
          div.className = 'flex items-center gap-2';
          div.innerHTML = `
            <input type="text" class="imagem-input bg-transparent pill px-3 py-2 rounded-lg flex-1" placeholder="URL da imagem ${index + 1}" value="${url}" />
            <button type="button" class="remove-imagem-btn text-red-400 hover:text-red-300 p-1" title="Remover imagem">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          `;
          container.appendChild(div);
          
          // Adicionar event listener para remover
          div.querySelector('.remove-imagem-btn').addEventListener('click', () => {
            div.remove();
          });
        });
      } else {
        // Adicionar pelo menos um campo vazio
        addImagemField();
      }
    }

    // Event listeners para gerenciar imagens
    qs('#addImagemBtn').addEventListener('click', addImagemField);
    
    // Inicializar com pelo menos um campo de imagem
    if (qs('#imagensContainer').children.length === 0) {
      addImagemField();
    }

    // Função para navegar na galeria de imagens
    function initGalleryNavigation() {
      // Event delegation para botões de navegação
      document.addEventListener('click', (e) => {
        if (e.target.closest('.gallery-prev, .gallery-next, .gallery-dot, .thumbnail-item')) {
          e.preventDefault();
          e.stopPropagation(); // Previne que o clique nas setas/miniaturas abra o zoom
          const button = e.target.closest('.gallery-prev, .gallery-next, .gallery-dot, .thumbnail-item');
          const galleryId = button.getAttribute('data-gallery-id');
          const gallery = document.querySelector(`[data-gallery-id="${galleryId}"]`);
          
          if (!gallery) return;
          
          const images = gallery.querySelectorAll('img[data-index]');
          const dots = document.querySelectorAll(`[data-gallery-id="${galleryId}"].gallery-dot`);
          const thumbnails = document.querySelectorAll(`[data-gallery-id="${galleryId}"].thumbnail-item`);
          const currentIndex = Array.from(images).findIndex(img => img.classList.contains('opacity-100'));
          
          let newIndex = currentIndex;
          
          if (button.classList.contains('gallery-prev')) {
            newIndex = currentIndex > 0 ? currentIndex - 1 : images.length - 1;
          } else if (button.classList.contains('gallery-next')) {
            newIndex = currentIndex < images.length - 1 ? currentIndex + 1 : 0;
          } else if (button.classList.contains('gallery-dot') || button.classList.contains('thumbnail-item')) {
            newIndex = parseInt(button.getAttribute('data-index'));
          }
          
          // Atualizar imagens
          images.forEach((img, index) => {
            img.classList.toggle('opacity-100', index === newIndex);
            img.classList.toggle('opacity-0', index !== newIndex);
          });
          
          // Atualizar dots
          dots.forEach((dot, index) => {
            dot.classList.toggle('bg-white', index === newIndex);
            dot.classList.toggle('bg-white/50', index !== newIndex);
          });
          
          // Atualizar miniaturas
          thumbnails.forEach((thumb, index) => {
            thumb.classList.toggle('border-emerald-400', index === newIndex);
            thumb.classList.toggle('border-transparent', index !== newIndex);
          });
        }
        
        // Clique na imagem principal para zoom (apenas se não for em botões ou controles)
        if (e.target.closest('#mainImageContainer') && 
            !e.target.closest('.gallery-prev, .gallery-next, .gallery-dot, .thumbnail-item')) {
          const container = e.target.closest('#mainImageContainer');
          const gallery = container.querySelector('.main-image-gallery');
          if (gallery) {
            const currentImg = gallery.querySelector('img.opacity-100');
            if (currentImg) {
              openImageZoom(currentImg.src, currentImg.alt);
            }
          }
        }
      });
    }

    // Função para abrir modal de zoom
    function openImageZoom(imageSrc, imageAlt) {
      // Criar modal se não existir
      let modal = document.getElementById('imageZoomModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'imageZoomModal';
        modal.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 hidden';
        modal.innerHTML = `
          <div class="relative max-w-4xl max-h-full">
            <button id="closeZoomModal" class="absolute top-4 right-4 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full z-10">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
            <img id="zoomedImage" class="max-w-full max-h-full object-contain rounded-lg" alt="">
          </div>
        `;
        document.body.appendChild(modal);
        
        // Event listeners do modal
        modal.querySelector('#closeZoomModal').addEventListener('click', () => {
          modal.classList.add('hidden');
        });
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.add('hidden');
          }
        });
        
        // Fechar com ESC
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
          }
        });
      }
      
      // Mostrar imagem
      modal.querySelector('#zoomedImage').src = imageSrc;
      modal.querySelector('#zoomedImage').alt = imageAlt;
      modal.classList.remove('hidden');
    }

    // Inicializar navegação da galeria
    initGalleryNavigation();

    qs('#btnSalvarProduto').addEventListener('click', async () => {
      if (!state.user) { toast('Faça login com Google para salvar produtos.'); return; }
      
      // Verificar se é edição
      const editId = qs('#btnSalvarProduto').getAttribute('data-edit-id');
      const isEdit = !!editId;
      
      // Verificar rate limiting
      if (!checkRateLimit('addProduct', 5, 60000)) { // 5 produtos por minuto
        toast('Muitas tentativas. Aguarde 1 minuto.');
        return;
      }
      
      // Coletar e sanitizar dados
      const nome = sanitizeText(qs('#admNome').value.trim());
      const cat = qs('#admCategoria').value;
      const preco = parseFloat(qs('#admPreco').value.replace(',','.'))||0;
      const promo = qs('#admPromo').value ? parseFloat(qs('#admPromo').value.replace(',','.')) : null;
      const imagens = getImagens() || [];
      const cores = qs('#admCores').value.split(',').map(s=>sanitizeText(s.trim())).filter(Boolean);
      const tams = qs('#admTamanhos').value.split(',').map(s=>sanitizeText(s.trim())).filter(Boolean);
      const desc = sanitizeText(qs('#admDesc').value.trim());
      const composicao = sanitizeText(qs('#admComposicao').value.trim()) || 'A definir';
      const estilo = sanitizeText(qs('#admEstilo').value.trim()) || 'TFI Signature';
      const envio = sanitizeText(qs('#admEnvio').value.trim()) || 'Rápido e rastreável';
      
      // Validar dados
      const produto = { nome, categoria: cat, preco, promo, imagens, cores, tamanhos: tams, descricao: desc, composicao, estilo, envio };
      const validation = validateProduct(produto);
      
      if (!validation.isValid) {
        toast('Erro: ' + validation.errors.join(', '));
        return;
      }
      
      if (!nome || !preco || !cores.length || !tams.length) { 
        toast('Preencha os campos obrigatórios.'); 
        return; 
      }
      
      try {
        if (isEdit) {
          // Verificar se o documento existe no Firestore
          const docRef = db.collection('produtos').doc(editId);
          const docSnapshot = await docRef.get();
          
          const produtoData = {
            nome,
            categoria: cat,
            preco,
            promo,
            cores,
            tamanhos: tams,
            descricao: desc || 'Sem descrição',
            composicao,
            estilo,
            envio,
            imagem: imagens.length > 0 ? imagens[0] : null,
            imagens: imagens.length > 0 ? imagens : [],
            atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          if (docSnapshot.exists) {
            // Documento existe, atualizar
            await docRef.update(produtoData);
          } else {
            // Documento não existe, criar novo
            await docRef.set({
              ...produtoData,
              criadoPor: state.user.uid,
              criadoEm: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          
          // Atualizar no estado local
          const idx = state.produtos.findIndex(p => p.id === editId);
          if (idx >= 0) {
            state.produtos[idx] = { ...state.produtos[idx], ...produtoData };
          }
          
          toast('Produto atualizado com sucesso!');
          
        } else {
          // Criar novo produto
          const produtoData = {
        nome, 
        categoria: cat, 
        preco, 
        promo, 
        cores, 
        tamanhos: tams, 
        novas: true, 
        destaque: false, 
        descricao: desc || 'Sem descrição', 
        composicao: 'A definir', 
        estilo: 'TFI Signature', 
            imagem: imagens.length > 0 ? imagens[0] : null,
            imagens: imagens.length > 0 ? imagens : [],
            criadoPor: state.user.uid,
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          const docRef = await db.collection('produtos').add(produtoData);
          
          // Adicionar ao estado local
          const novo = { 
            id: docRef.id, 
            ...produtoData
      };
      
      state.produtos.unshift(novo);
          toast('Produto salvo com sucesso!');
        }
        
      persistLocalProducts();
      filterAndRenderCatalog(); 
      renderDestaques(); 
      renderNovidades(); 
      renderAdminList();
        
        // Limpar formulário e resetar botão
        ['#admNome','#admPreco','#admPromo','#admCores','#admTamanhos','#admDesc','#admComposicao','#admEstilo','#admEnvio'].forEach(s=>qs(s).value='');
        setImagens([]); // Limpar imagens
        qs('#btnSalvarProduto').textContent = 'Salvar Produto';
        qs('#btnSalvarProduto').removeAttribute('data-edit-id');
        
      } catch (error) {
        console.error('Erro ao salvar produto:', error);
        
        // Mensagem de erro mais específica
        if (error.code === 'permission-denied') {
          toast('Erro de permissão. Verifique se você tem acesso de administrador.');
        } else if (error.code === 'not-found') {
          toast('Produto não encontrado. Tente recarregar a página.');
        } else if (error.message.includes('No document to update')) {
          toast('Produto não existe no servidor. Criando novo produto...');
          // Tentar criar como novo produto
          try {
            const docRef = await db.collection('produtos').add({
              nome,
              categoria: cat,
              preco,
              promo,
              cores,
              tamanhos: tams,
              descricao: desc || 'Sem descrição',
              composicao,
              estilo,
              envio,
              imagem: imagens.length > 0 ? imagens[0] : null,
              imagens: imagens.length > 0 ? imagens : [],
              criadoPor: state.user.uid,
              criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
              atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Atualizar ID no estado local
            const idx = state.produtos.findIndex(p => p.id === editId);
            if (idx >= 0) {
              state.produtos[idx].id = docRef.id;
            }
            
            toast('Produto criado com sucesso!');
          } catch (createError) {
            console.error('Erro ao criar produto:', createError);
            toast('Erro ao criar produto. Tente novamente.');
          }
        } else {
          toast('Erro ao salvar produto. Tente novamente.');
        }
      }
    });

    // Event listeners para coleção destaque
    qs('#featuredCollectionName').addEventListener('input', (e) => {
      state.featuredCollection.name = e.target.value;
      updateFeaturedPreview();
    });

    qs('#btnSaveFeatured').addEventListener('click', () => {
      saveFeaturedCollection();
      toast('Coleção destaque salva com sucesso!');
    });
    function renderAdminList() {
      const box = qs('#adminLista'); 
      box.innerHTML='';
      
      // Atualizar contador de produtos
      qs('#totalProducts').textContent = state.produtos.length;
      
      state.produtos.forEach(p=>{
        const row = document.createElement('div');
        row.className='glass rounded-xl p-4 flex items-center justify-between hover:ring-2 hover:ring-emerald-400/20 transition-all';
        row.innerHTML = `
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-800 flex-shrink-0">
              ${(p.imagens && p.imagens[0]) || p.imagem ? 
                `<img src="${(p.imagens && p.imagens[0]) || p.imagem}" alt="${p.nome}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                 <div class="w-full h-full flex items-center justify-center text-gray-400" style="display:none;">📦</div>` :
                `<div class="w-full h-full flex items-center justify-center text-gray-400">📦</div>`
              }
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-bold text-lg truncate">${p.nome}</div>
              <div class="hint text-sm mb-1">${p.categoria}</div>
              <div class="flex items-center gap-2 text-sm">
                <span class="font-semibold text-emerald-400">${fmt(p.promo ?? p.preco)}</span>
                ${p.promo ? `<span class="line-through text-slate-500">${fmt(p.preco)}</span>` : ''}
                ${p.destaque ? '<span class="badge px-2 py-1 rounded-full text-xs">Destaque</span>' : ''}
                ${p.novas ? '<span class="badge px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-300">Novo</span>' : ''}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn pill px-3 py-2 rounded-lg text-xs hover:bg-blue-500/20 hover:text-blue-300" data-id="${p.id}" data-act="edit">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              Editar
            </button>
            <button class="btn pill px-3 py-2 rounded-lg text-xs ${p.destaque ? 'bg-yellow-500/20 text-yellow-300 hover:bg-yellow-500/30' : 'hover:bg-yellow-500/20 hover:text-yellow-300'}" data-id="${p.id}" data-act="dest">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
              </svg>
              ${p.destaque ? 'Remover Destaque' : 'Destacar'}
            </button>
            <button class="btn pill px-3 py-2 rounded-lg text-xs hover:bg-red-500/20 hover:text-red-300" data-id="${p.id}" data-act="delete">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              Excluir
            </button>
          </div>
        `;
        box.appendChild(row);
      });
      box.onclick = async (e)=>{
        const b = e.target.closest('button'); if(!b) return;
        const id=b.getAttribute('data-id'); const act=b.getAttribute('data-act');
        const idx = state.produtos.findIndex(p=>p.id===id); if (idx<0) return;
        
        try {
          if (act==='edit') {
            // Preencher formulário com dados do produto
            const produto = state.produtos[idx];
            qs('#admNome').value = produto.nome || '';
            qs('#admCategoria').value = produto.categoria || '';
            qs('#admPreco').value = produto.preco || '';
            qs('#admPromo').value = produto.promo || '';
            setImagens(produto.imagens || []);
            qs('#admCores').value = produto.cores ? produto.cores.join(', ') : '';
            qs('#admTamanhos').value = produto.tamanhos ? produto.tamanhos.join(', ') : '';
            qs('#admDesc').value = produto.descricao || '';
            qs('#admComposicao').value = produto.composicao || '';
            qs('#admEstilo').value = produto.estilo || '';
            qs('#admEnvio').value = produto.envio || '';
            
            // Alterar botão para "Atualizar"
            qs('#btnSalvarProduto').textContent = 'Atualizar Produto';
            qs('#btnSalvarProduto').setAttribute('data-edit-id', id);
            
            // Scroll para o formulário
            qs('#admNome').scrollIntoView({ behavior: 'smooth' });
            toast('Formulário preenchido. Edite e clique em "Atualizar Produto".');
          }
          else if (act==='dest') {
            state.produtos[idx].destaque = !state.produtos[idx].destaque;
            // Atualizar no Firestore se disponível
            if (db) {
              try {
                await db.collection('produtos').doc(id).update({
                  destaque: state.produtos[idx].destaque,
                  atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });
              } catch (error) {
                console.error('Erro ao atualizar destaque no Firestore:', error);
              }
            }
            toast('Destaque atualizado!');
          }
          else if (act==='delete') {
            // Excluir produto
            if (confirm(`Tem certeza que deseja excluir o produto "${state.produtos[idx].nome}"?`)) {
              // Remover do Firestore se disponível
              if (db) {
                try {
                  await db.collection('produtos').doc(id).delete();
                } catch (error) {
                  console.error('Erro ao excluir produto do Firestore:', error);
                }
              }
              
              // Remover do estado local
              state.produtos.splice(idx, 1);
              
              // Remover da coleção destaque se estiver lá
              const featuredIndex = state.featuredCollection.products.indexOf(id);
              if (featuredIndex > -1) {
                state.featuredCollection.products.splice(featuredIndex, 1);
                saveFeaturedCollection();
              }
              
              toast('Produto excluído com sucesso!');
            }
          }
          
          persistLocalProducts(); 
          renderAdminList(); 
          renderDestaques(); 
          filterAndRenderCatalog(); 
          renderNovidades();
          
        } catch (error) {
          console.error('Erro ao atualizar produto:', error);
          toast('Erro ao atualizar produto.');
        }
      }
    }
    function persistLocalProducts() {
      localStorage.setItem('tfi_products', JSON.stringify(state.produtos));
    }
    function loadLocalProducts() {
      try {
        const arr = JSON.parse(localStorage.getItem('tfi_products')||'[]');
        if (Array.isArray(arr) && arr.length) state.produtos = arr;
      } catch {}
    }

    // Admin: Carregar e exibir pedidos dos clientes
    let allOrders = [];
    
    async function loadOrdersFromFirestore() {
      try {
        if (!db || !isAdmin()) return;
        
        console.log('📦 Carregando pedidos do Firestore...');
        const ordersSnapshot = await db.collection('orders').orderBy('createdAt', 'desc').get();
        
        allOrders = [];
        ordersSnapshot.forEach(doc => {
          const orderData = doc.data();
          allOrders.push({
            id: doc.id,
            ...orderData
          });
        });
        
        console.log(`✅ ${allOrders.length} pedidos carregados`);
        renderOrdersList();
        
      } catch (error) {
        console.error('❌ Erro ao carregar pedidos:', error);
        toast('Erro ao carregar pedidos');
      }
    }
    
    function renderOrdersList() {
      const container = qs('#ordersList');
      const totalOrders = qs('#totalOrders');
      
      if (!container) return;
      
      // Aplicar filtros
      let filteredOrders = [...allOrders];
      
      const statusFilter = qs('#filterStatus')?.value;
      const paymentFilter = qs('#filterPayment')?.value;
      const dateFilter = qs('#filterDate')?.value;
      const searchFilter = qs('#filterSearch')?.value;
      
      if (statusFilter) {
        filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
      }
      
      if (paymentFilter) {
        filteredOrders = filteredOrders.filter(order => order.paymentMethod === paymentFilter);
      }
      
      if (dateFilter) {
        const filterDate = new Date(dateFilter);
        filteredOrders = filteredOrders.filter(order => {
          const orderDate = new Date(order.createdAt);
          return orderDate.toDateString() === filterDate.toDateString();
        });
      }
      
      if (searchFilter) {
        const search = searchFilter.toLowerCase();
        filteredOrders = filteredOrders.filter(order => 
          order.customer?.nome?.toLowerCase().includes(search) ||
          order.customer?.email?.toLowerCase().includes(search) ||
          order.external_reference?.toLowerCase().includes(search) ||
          order.id?.toLowerCase().includes(search)
        );
      }
      
      // Atualizar contador
      if (totalOrders) {
        totalOrders.textContent = filteredOrders.length;
      }
      
      // Renderizar lista
      container.innerHTML = '';
      
      if (filteredOrders.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-slate-400">
            <svg class="w-12 h-12 mx-auto mb-3 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <p>Nenhum pedido encontrado</p>
          </div>
        `;
        return;
      }
      
      filteredOrders.forEach(order => {
        const orderElement = createOrderElement(order);
        container.appendChild(orderElement);
      });
    }
    
    function createOrderElement(order) {
      const div = document.createElement('div');
      div.className = 'glass rounded-xl p-4 hover:ring-2 hover:ring-emerald-400/20 transition-all';
      
      const statusColors = {
        pending: 'text-yellow-400 bg-yellow-400/20',
        confirmed: 'text-green-400 bg-green-400/20',
        processing: 'text-blue-400 bg-blue-400/20',
        shipped: 'text-purple-400 bg-purple-400/20',
        delivered: 'text-emerald-400 bg-emerald-400/20',
        cancelled: 'text-red-400 bg-red-400/20'
      };
      
      const statusText = {
        pending: 'Pendente',
        confirmed: 'Confirmado',
        processing: 'Processando',
        shipped: 'Enviado',
        delivered: 'Entregue',
        cancelled: 'Cancelado'
      };
      
      const total = order.items?.reduce((sum, item) => sum + (item.preco * item.quantidade), 0) || 0;
      const frete = order.shipping?.price || 0;
      const totalComFrete = total + frete;
      
      div.innerHTML = `
        <div class="flex items-start justify-between mb-3">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="font-bold text-lg">#${order.external_reference || order.id}</span>
              <span class="badge px-2 py-1 rounded-full text-xs ${statusColors[order.status] || 'text-gray-400 bg-gray-400/20'}">
                ${statusText[order.status] || order.status}
              </span>
              <span class="text-sm text-slate-400">
                💳 ${order.paymentMethod?.toUpperCase() || 'N/A'}
              </span>
            </div>
            <div class="text-sm text-slate-300 mb-1">
              <strong>Cliente:</strong> ${order.customer?.nome || 'N/A'}
            </div>
            <div class="text-sm text-slate-300 mb-1">
              <strong>Email:</strong> ${order.customer?.email || 'N/A'}
            </div>
            <div class="text-sm text-slate-300 mb-1">
              <strong>Data:</strong> ${new Date(order.createdAt).toLocaleDateString('pt-BR')}
            </div>
          </div>
          <div class="text-right">
            <div class="text-lg font-bold text-emerald-400">
              R$ ${totalComFrete.toFixed(2).replace('.', ',')}
            </div>
            <div class="text-xs text-slate-400">
              ${order.items?.length || 0} item(s)
            </div>
          </div>
        </div>
        
        <div class="border-t border-slate-700 pt-3">
          <div class="text-sm text-slate-300 mb-2">
            <strong>Endereço:</strong> ${order.shipping?.address || 'N/A'}
          </div>
          <div class="flex items-center justify-between">
            <div class="text-xs text-slate-400">
              ID: ${order.id}
            </div>
            <div class="flex gap-2">
              <button class="btn pill px-3 py-1 rounded-lg text-xs hover:bg-emerald-500/20" onclick="viewOrderDetails('${order.id}')">
                Ver Detalhes
              </button>
            </div>
          </div>
        </div>
      `;
      
      return div;
    }
    
    // Função para visualizar detalhes do pedido
    function viewOrderDetails(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;
      
      const itemsHtml = order.items?.map(item => `
        <div class="flex items-center gap-3 p-2 bg-slate-800/50 rounded-lg">
          <div class="w-12 h-12 bg-slate-700 rounded-lg flex items-center justify-center">
            ${(item.imagens && item.imagens[0]) || item.imagem ? `<img src="${(item.imagens && item.imagens[0]) || item.imagem}" alt="${item.nome}" class="w-full h-full object-cover rounded-lg">` : '📦'}
          </div>
          <div class="flex-1">
            <div class="font-medium">${item.nome}</div>
            <div class="text-sm text-slate-400">Qtd: ${item.quantidade} | R$ ${item.preco.toFixed(2).replace('.', ',')}</div>
          </div>
          <div class="font-bold">R$ ${(item.preco * item.quantidade).toFixed(2).replace('.', ',')}</div>
        </div>
      `).join('') || '<p class="text-slate-400">Nenhum item encontrado</p>';
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="glass rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Detalhes do Pedido #${order.external_reference || order.id}</h3>
            <button onclick="this.closest('.fixed').remove()" class="btn pill px-3 py-1 rounded-lg text-sm">✕</button>
          </div>
          
          <div class="space-y-4">
            <div>
              <h4 class="font-bold mb-2">Informações do Cliente</h4>
              <div class="bg-slate-800/50 rounded-lg p-3 text-sm">
                <div><strong>Nome:</strong> ${order.customer?.nome || 'N/A'}</div>
                <div><strong>Email:</strong> ${order.customer?.email || 'N/A'}</div>
                <div><strong>Telefone:</strong> ${order.customer?.telefone || 'N/A'}</div>
                <div><strong>CPF:</strong> ${order.customer?.cpf || 'N/A'}</div>
              </div>
            </div>
            
            <div>
              <h4 class="font-bold mb-2">Endereço de Entrega</h4>
              <div class="bg-slate-800/50 rounded-lg p-3 text-sm">
                <div>${order.shipping?.address || 'N/A'}</div>
                <div>${order.shipping?.city || ''} - ${order.shipping?.state || ''}</div>
                <div>CEP: ${order.shipping?.postalCode || 'N/A'}</div>
              </div>
            </div>
            
            <div>
              <h4 class="font-bold mb-2">Itens do Pedido</h4>
              <div class="space-y-2">
                ${itemsHtml}
              </div>
            </div>
            
            <div class="border-t border-slate-700 pt-4">
              <div class="flex justify-between items-center">
                <span class="font-bold">Total:</span>
                <span class="text-xl font-bold text-emerald-400">R$ ${(order.items?.reduce((sum, item) => sum + (item.preco * item.quantidade), 0) + (order.shipping?.price || 0)).toFixed(2).replace('.', ',')}</span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Admin: Gerenciar Coleção Destaque
    function renderFeaturedProductsList() {
      const container = qs('#featuredProductsList');
      container.innerHTML = '';
      
      state.produtos.forEach(produto => {
        const isSelected = state.featuredCollection.products.includes(produto.id);
        const canSelect = !isSelected && state.featuredCollection.products.length < 3;
        
        const item = document.createElement('div');
        item.className = `flex items-center justify-between p-2 rounded-lg border ${isSelected ? 'border-emerald-400 bg-emerald-400/10' : 'border-slate-600'}`;
        item.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-slate-700 flex items-center justify-center">
              ${(produto.imagens && produto.imagens[0]) || produto.imagem ? `<img src="${(produto.imagens && produto.imagens[0]) || produto.imagem}" alt="${produto.nome}" class="w-6 h-6 rounded object-cover">` : '📦'}
            </div>
            <div>
              <div class="text-sm font-medium">${produto.nome}</div>
              <div class="text-xs text-slate-400">${produto.categoria}</div>
            </div>
          </div>
          <button class="btn pill px-3 py-1 text-xs ${isSelected ? 'bg-emerald-500 text-black' : canSelect ? 'hover:bg-emerald-500/20' : 'opacity-50 cursor-not-allowed'}" 
                  data-id="${produto.id}" 
                  ${!canSelect && !isSelected ? 'disabled' : ''}>
            ${isSelected ? 'Remover' : 'Adicionar'}
          </button>
        `;
        
        if (canSelect || isSelected) {
          item.querySelector('button').addEventListener('click', () => {
            toggleFeaturedProduct(produto.id);
          });
        }
        
        container.appendChild(item);
      });
      
      updateFeaturedPreview();
    }

    function toggleFeaturedProduct(productId) {
      const index = state.featuredCollection.products.indexOf(productId);
      
      if (index > -1) {
        // Remover produto
        state.featuredCollection.products.splice(index, 1);
      } else if (state.featuredCollection.products.length < 3) {
        // Adicionar produto
        state.featuredCollection.products.push(productId);
      }
      
      renderFeaturedProductsList();
      saveFeaturedCollection();
    }

    function updateFeaturedPreview() {
      qs('#previewCollectionName').textContent = state.featuredCollection.name;
      qs('#previewProductCount').textContent = state.featuredCollection.products.length;
      
      // Atualizar também o nome na home
      const homeElement = qs('#homeCollectionName');
      if (homeElement) {
        homeElement.textContent = state.featuredCollection.name;
      }
    }

    function saveFeaturedCollection() {
      // Salvar no localStorage
      localStorage.setItem('tfi_featured_collection', JSON.stringify(state.featuredCollection));
      
      // Salvar no Firestore se estiver logado e for admin
      if (state.user && db && isAdmin()) {
        db.collection('configuracoes').doc('featured_collection').set(state.featuredCollection)
          .catch(error => {
            console.error('Erro ao salvar coleção destaque:', error);
            toast('Erro ao salvar no servidor. Dados salvos localmente.');
          });
      }
      
      // Atualizar a seção destaque na home
      renderDestaques();
    }

    function loadFeaturedCollection() {
      // Carregar do localStorage
      const saved = localStorage.getItem('tfi_featured_collection');
      if (saved) {
        try {
          state.featuredCollection = JSON.parse(saved);
        } catch (error) {
          console.error('Erro ao carregar coleção destaque:', error);
        }
      }
      
      // Carregar do Firestore se estiver logado e for admin
      if (state.user && db && isAdmin()) {
        db.collection('configuracoes').doc('featured_collection').get()
          .then(doc => {
            if (doc.exists) {
              state.featuredCollection = doc.data();
              renderFeaturedProductsList();
            }
          })
          .catch(error => {
            console.error('Erro ao carregar coleção destaque do Firestore:', error);
            // Continuar com dados do localStorage se houver erro
            renderFeaturedProductsList();
          });
      } else {
        // Se não for admin, usar apenas dados locais
        renderFeaturedProductsList();
      }
    }



    // Firebase Configuration
    let firebaseConfig;
    let firebaseApp, auth, db, provider;
    
    // Serviços de integração
    let orderManager;
    
    async function loadFirebaseConfig() {
      try {
        const configModule = await import('./config.js');
        firebaseConfig = configModule.firebaseConfig;
      } catch (error) {
        console.error('Erro ao carregar configuração:', error);
        // Fallback para configuração padrão
        firebaseConfig = {
          apiKey: "AIzaSyD__XrPqFeh4_K0ih4l1reNvWxjW7VItPw",
          authDomain: "tfimports-27898.firebaseapp.com",
          projectId: "tfimports-27898",
          storageBucket: "tfimports-27898.firebasestorage.app",
          messagingSenderId: "379291286011",
          appId: "1:379291286011:web:1feb4711b5235b04c4b35e",
          measurementId: "G-B742BVBRES"
        };
      }
    }
    
    async function initializeFirebase() {
      await loadFirebaseConfig();
      
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        provider = new firebase.auth.GoogleAuthProvider();
        
        // Configurações básicas do Google Auth
        provider.addScope('email');
        provider.addScope('profile');
        
        // Configurar persistência de autenticação
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        
        // Inicializar OrderManager
        orderManager = new OrderManager(db);
        
        // Configurar listener de mudança de estado de autenticação
        auth.onAuthStateChanged(async u => { 
          state.user = u || null; 
          updateAuthUI(); 
          
          // Carregar favoritos do usuário quando logar
          if (u) {
            await loadFavoritos();
            saveLocalUserData();
            
            // Se veio de um redirect, fechar modal e mostrar sucesso
            if (auth.isSignInWithRedirect()) {
              closeLoginModal();
              toast('Login realizado com sucesso!');
              
              // Salvar dados do usuário no Firestore
              await saveUserData();
            }
          } else {
            localStorage.removeItem('tfi_user');
            // Limpar favoritos quando deslogar
            state.favoritos = [];
            updateFavoritosUI();
          }
        });
        
      } catch (e) {
        console.error('Erro ao inicializar Firebase:', e);
      }
    }
    function updateAuthUI() {
      if (state.user) {
        const isUserAdmin = isAdmin();
        
        // Salvar dados do usuário localmente como backup
        saveLocalUserData();
        
        // Atualizar estado do admin
        qs('#authState').textContent = `Olá, ${state.user.displayName||'admin'}`;
        qs('#btnLogout').classList.toggle('hidden', !isUserAdmin);
        qs('#btnAdminLogin').classList.toggle('hidden', isUserAdmin);
        
        // Esconder botão "Entrar" quando logado
        qs('#btnLogin').classList.add('hidden');
        
        // Mostrar links corretos na navegação
        qs('#navMinhaConta').classList.toggle('hidden', isUserAdmin);
        qs('#navAdmin').classList.toggle('hidden', !isUserAdmin);
        qs('#navMinhaContaMobile').classList.toggle('hidden', isUserAdmin);
        qs('#navAdminMobile').classList.toggle('hidden', !isUserAdmin);
        
      } else {
        // Usuário não logado - limpar dados locais
        localStorage.removeItem('tfi_user');
        
        // Usuário não logado
        qs('#authState').textContent = 'Não autenticado';
        qs('#btnLogout').classList.add('hidden');
        qs('#btnAdminLogin').classList.remove('hidden');
        
        // Mostrar botão "Entrar" quando não logado
        qs('#btnLogin').classList.remove('hidden');
        qs('#btnLogin').textContent = 'Entrar';
        qs('#btnLogin').onclick = openLoginModal;
        
        // Esconder links de navegação
        qs('#navMinhaConta').classList.add('hidden');
        qs('#navAdmin').classList.add('hidden');
        qs('#navMinhaContaMobile').classList.add('hidden');
        qs('#navAdminMobile').classList.add('hidden');
      }
    }
    // Login com email/senha
    async function signInEmail() {
      const email = qs('#loginEmail').value.trim();
      const password = qs('#loginPassword').value;
      
      if (!email || !password) {
        toast('Preencha email e senha.');
        return;
      }
      
      if (!auth) { toast('Login indisponível neste ambiente.'); return; }
      
      try {
        const res = await auth.signInWithEmailAndPassword(email, password);
        state.user = res.user;
        updateAuthUI();
        closeLoginModal();
        toast('Login realizado com sucesso!');
        
        // Salvar dados do usuário no Firestore
        await saveUserData();
        
      } catch (error) {
        console.error('Erro no login:', error);
        if (error.code === 'auth/user-not-found') {
          toast('Usuário não encontrado.');
        } else if (error.code === 'auth/wrong-password') {
          toast('Senha incorreta.');
        } else if (error.code === 'auth/invalid-email') {
          toast('Email inválido.');
        } else {
          toast('Erro no login. Tente novamente.');
        }
      }
    }
    
    // Recuperação de senha
    async function sendPasswordReset() {
      const email = qs('#forgotEmail').value.trim();
      
      if (!email) {
        toast('Digite seu email.');
        return;
      }
      
      if (!auth) { 
        toast('Recuperação indisponível neste ambiente.'); 
        return; 
      }
      
      try {
        // Mostrar loading
        const btn = qs('#btnSendReset');
        const originalText = btn.textContent;
        btn.textContent = 'Enviando...';
        btn.disabled = true;
        
        await auth.sendPasswordResetEmail(email);
        
        // Mostrar sucesso
        btn.textContent = '✅ Email Enviado!';
        btn.classList.add('bg-green-600');
        
        // Feedback visual melhorado
        toast('📧 Email de recuperação enviado! Verifique sua caixa de entrada e a pasta de spam.', 'success');
        
        // Aguardar um pouco antes de voltar
        setTimeout(() => {
          showLoginForm();
          btn.textContent = originalText;
          btn.disabled = false;
          btn.classList.remove('bg-green-600');
        }, 3000);
        
      } catch (error) {
        console.error('Erro ao enviar email de recuperação:', error);
        if (error.code === 'auth/user-not-found') {
          toast('Email não encontrado.');
        } else if (error.code === 'auth/invalid-email') {
          toast('Email inválido.');
        } else {
          toast('Erro ao enviar email. Tente novamente.');
        }
      }
    }
    
    // Mostrar formulário de recuperação
    function showForgotPasswordForm() {
      qs('#emailLoginForm').classList.add('hidden');
      qs('#registerForm').classList.add('hidden');
      qs('#forgotPasswordForm').classList.remove('hidden');
    }
    
    // Voltar ao login
    function backToLogin() {
      qs('#forgotPasswordForm').classList.add('hidden');
      qs('#registerForm').classList.add('hidden');
      qs('#emailLoginForm').classList.remove('hidden');
    }
    
    // Registro com email/senha
    async function signUpEmail() {
      const name = qs('#registerName').value.trim();
      const email = qs('#registerEmail').value.trim();
      const password = qs('#registerPassword').value;
      
      if (!name || !email || !password) {
        toast('Preencha todos os campos.');
        return;
      }
      
      if (password.length < 6) {
        toast('Senha deve ter pelo menos 6 caracteres.');
        return;
      }
      
      if (!auth) { toast('Registro indisponível neste ambiente.'); return; }
      
      try {
        const res = await auth.createUserWithEmailAndPassword(email, password);
        
        // Atualizar perfil do usuário
        await res.user.updateProfile({
          displayName: name
        });
        
        state.user = res.user;
        updateAuthUI();
        closeLoginModal();
        toast('Conta criada com sucesso!');
        
        // Salvar dados do usuário no Firestore
        await saveUserData();
        
      } catch (error) {
        console.error('Erro no registro:', error);
        if (error.code === 'auth/email-already-in-use') {
          toast('Email já está em uso.');
        } else if (error.code === 'auth/weak-password') {
          toast('Senha muito fraca.');
        } else if (error.code === 'auth/invalid-email') {
          toast('Email inválido.');
        } else {
          toast('Erro ao criar conta. Tente novamente.');
        }
      }
    }
    
    // Login com Google
    async function signInGoogle() {
      if (!auth) { 
        toast('Login indisponível neste ambiente.'); 
        return; 
      }
      
      try {
        // Usar popup com configuração específica para evitar erro 403
        const result = await auth.signInWithPopup(provider);
        state.user = result.user;
        updateAuthUI();
        closeLoginModal();
        toast('Login realizado com sucesso!');
        
        // Salvar dados do usuário no Firestore
        await saveUserData();
        
      } catch (error) {
        console.error('Erro no login:', error);
        
        if (error.code === 'auth/popup-closed-by-user') {
          toast('Login cancelado pelo usuário.');
        } else if (error.code === 'auth/popup-blocked') {
          toast('Popup bloqueado. Permita popups para este site.');
        } else {
          toast('Erro no login. Tente novamente.');
        }
      }
    }
    
    // Salvar dados do usuário no Firestore
    async function saveUserData() {
      try {
        await db.collection('usuarios').doc(state.user.uid).set({
          nome: state.user.displayName,
          email: state.user.email,
          ultimoLogin: firebase.firestore.FieldValue.serverTimestamp(),
          isAdmin: false // Por padrão, novos usuários não são admin
        }, { merge: true });
      } catch (error) {
        console.error('Erro ao salvar dados do usuário:', error);
      }
    }
    function signOut() {
      if (!auth) { state.user=null; updateAuthUI(); return; }
      auth.signOut().then(()=> { state.user=null; updateAuthUI(); toast('Você saiu.'); });
    }
    
    // Controle do modal de tipo de peça
    let currentProdutoIdForModal = null;
    function openTipoPecaModal(id) {
      currentProdutoIdForModal = id;
      qs('#tipoPecaModal').classList.remove('hidden');
    }
    function closeTipoPecaModal() {
      qs('#tipoPecaModal').classList.add('hidden');
      currentProdutoIdForModal = null;
    }

    // Controle do modal de login
    function openLoginModal() {
      qs('#loginModal').classList.remove('hidden');
    }
    
    function closeLoginModal() {
      qs('#loginModal').classList.add('hidden');
      // Limpar formulários
      qs('#loginEmail').value = '';
      qs('#loginPassword').value = '';
      qs('#registerName').value = '';
      qs('#registerEmail').value = '';
      qs('#registerPassword').value = '';
      // Mostrar formulário de login por padrão
      qs('#emailLoginForm').classList.remove('hidden');
      qs('#registerForm').classList.add('hidden');
    }
    
    function showRegisterForm() {
      qs('#emailLoginForm').classList.add('hidden');
      qs('#registerForm').classList.remove('hidden');
    }
    
    function showLoginForm() {
      qs('#emailLoginForm').classList.remove('hidden');
      qs('#registerForm').classList.add('hidden');
    }
    
    // Event listeners
    const btnLogin = qs('#btnLogin');
    if (btnLogin) {
      btnLogin.addEventListener('click', openLoginModal);
    }
    
    const btnAdminLogin = qs('#btnAdminLogin');
    if (btnAdminLogin) {
      btnAdminLogin.addEventListener('click', openLoginModal);
    }
    
    const closeLogin = qs('#closeLogin');
    if (closeLogin) {
      closeLogin.addEventListener('click', closeLoginModal);
    }
    
    const closeTipoPecaModalBtn = qs('#closeTipoPecaModal');
    if (closeTipoPecaModalBtn) {
      closeTipoPecaModalBtn.addEventListener('click', closeTipoPecaModal);
    }
    
    // Event listeners do modal de tipo de peça
    qs('#tipoPecaModal').addEventListener('click', (e) => {
      if (e.target === qs('#tipoPecaModal')) {
        closeTipoPecaModal();
      }
    });
    
    // Event listeners dos botões do modal de tipo de peça
    qs('#tipoPecaModal').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-tipo]');
      if (!btn || !currentProdutoIdForModal) return;
      
      const tipo = btn.getAttribute('data-tipo');
      if (tipo === 'ver') {
        closeTipoPecaModal();
        openProduto(currentProdutoIdForModal);
      } else if (tipo === 'adicionar') {
        closeTipoPecaModal();
        addToCart(currentProdutoIdForModal);
      }
    });
    const btnEmailLogin = qs('#btnEmailLogin');
    if (btnEmailLogin) {
      btnEmailLogin.addEventListener('click', signInEmail);
    }
    
    const btnEmailRegister = qs('#btnEmailRegister');
    if (btnEmailRegister) {
      btnEmailRegister.addEventListener('click', signUpEmail);
    }
    
    const btnGoogleLogin = qs('#btnGoogleLogin');
    if (btnGoogleLogin) {
      btnGoogleLogin.addEventListener('click', signInGoogle);
    }
    
    const btnShowRegister = qs('#btnShowRegister');
    if (btnShowRegister) {
      btnShowRegister.addEventListener('click', showRegisterForm);
    }
    
    const btnShowLogin = qs('#btnShowLogin');
    if (btnShowLogin) {
      btnShowLogin.addEventListener('click', showLoginForm);
    }
    
    // Event listeners para recuperação de senha
    const btnForgotPassword = qs('#btnForgotPassword');
    if (btnForgotPassword) {
      btnForgotPassword.addEventListener('click', showForgotPasswordForm);
    }
    
    const btnSendReset = qs('#btnSendReset');
    if (btnSendReset) {
      btnSendReset.addEventListener('click', sendPasswordReset);
    }
    
    const btnBackToLogin = qs('#btnBackToLogin');
    if (btnBackToLogin) {
      btnBackToLogin.addEventListener('click', backToLogin);
    }
    
    const btnLogout = qs('#btnLogout');
    if (btnLogout) {
      btnLogout.addEventListener('click', signOut);
    }
    
    const btnLogoutUser = qs('#btnLogoutUser');
    if (btnLogoutUser) {
      btnLogoutUser.addEventListener('click', signOut);
    }
    
    // Event listeners para filtros de pedidos
    const btnRefreshOrders = qs('#btnRefreshOrders');
    if (btnRefreshOrders) {
      btnRefreshOrders.addEventListener('click', loadOrdersFromFirestore);
    }

    // Event listeners para gerenciar feedbacks
    const btnRefreshFeedbacks = qs('#btnRefreshFeedbacks');
    if (btnRefreshFeedbacks) {
      btnRefreshFeedbacks.addEventListener('click', refreshFeedbacks);
    }

    const btnClearFeedbacks = qs('#btnClearFeedbacks');
    if (btnClearFeedbacks) {
      btnClearFeedbacks.addEventListener('click', clearAllFeedbacks);
    }
    
    const filterStatus = qs('#filterStatus');
    if (filterStatus) {
      filterStatus.addEventListener('change', renderOrdersList);
    }
    
    const filterPayment = qs('#filterPayment');
    if (filterPayment) {
      filterPayment.addEventListener('change', renderOrdersList);
    }
    
    const filterDate = qs('#filterDate');
    if (filterDate) {
      filterDate.addEventListener('change', renderOrdersList);
    }
    
    const filterSearch = qs('#filterSearch');
    if (filterSearch) {
      filterSearch.addEventListener('input', renderOrdersList);
    }
    
    // Fechar modal ao clicar fora
    const loginModal = qs('#loginModal');
    if (loginModal) {
      loginModal.addEventListener('click', (e) => {
        if (e.target === loginModal) {
        closeLoginModal();
      }
    });
    }
    
    // Enter para login
    const loginPassword = qs('#loginPassword');
    if (loginPassword) {
      loginPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        signInEmail();
      }
    });
    }
    
    const registerPassword = qs('#registerPassword');
    if (registerPassword) {
      registerPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        signUpEmail();
      }
    });
    }
    
    // onAuthStateChanged agora está dentro de initializeFirebase()

    // Mini util: year
    const yearElement = qs('#year');
    if (yearElement) {
      yearElement.textContent = new Date().getFullYear();
    }

    // Inicialização
    async function init() {
      try {
        
      // Verificar dados locais do usuário primeiro (fallback)
      checkLocalUserData();
      
      // Carregar configuração do Firebase primeiro
      await initializeFirebase();
      
      // Carregar dados do Firestore
      await loadProductsFromFirestore();
      await loadFeedbacksFromFirestore();
      
      loadLocalProducts();
      loadCart();
      loadFavoritos();
      renderChips();
      renderDestaques();
      initFilters();
      filterAndRenderCatalog();
      renderNovidades();
      renderFeedbacks();
        
      } catch (error) {
        console.error('❌ Erro na inicialização:', error);
        // Continuar mesmo com erro para não quebrar a aplicação
        loadLocalProducts();
        loadCart();
        loadFavoritos();
        renderChips();
        renderDestaques();
        initFilters();
        filterAndRenderCatalog();
        renderNovidades();
        renderFeedbacks();
      }
      initRating();
      renderChat();
      adminFillCategorias();
      renderAdminList();
      loadFeaturedCollection();
      renderFeaturedProductsList();
      loadOrdersFromFirestore(); // Carregar pedidos para admin
      applyRoute();
    }
    
    // Carregar produtos do Firestore
    async function loadProductsFromFirestore() {
      try {
        if (!db) return;
        
        const snapshot = await db.collection('produtos').orderBy('criadoEm', 'desc').get();
        const firestoreProducts = [];
        
        snapshot.forEach(doc => {
          firestoreProducts.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Adicionar produtos do Firestore ao estado
        state.produtos = [...firestoreProducts, ...state.produtos];
        
        
      } catch (error) {
        console.error('Erro ao carregar produtos do Firestore:', error);
      }
    }
    
    // Carregar feedbacks do Firestore
    async function loadFeedbacksFromFirestore() {
      try {
        if (!db) return;
        
        const snapshot = await db.collection('feedbacks').orderBy('criadoEm', 'desc').limit(10).get();
        const firestoreFeedbacks = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          firestoreFeedbacks.push({
            nome: data.nome,
            nota: data.nota,
            texto: data.texto,
            data: data.data
          });
        });
        
        // Adicionar feedbacks do Firestore ao estado
        feedbacks.unshift(...firestoreFeedbacks);
        
        
        // Atualizar contador de feedbacks
        await updateFeedbackCount();
        
      } catch (error) {
        console.error('Erro ao carregar feedbacks do Firestore:', error);
      }
    }
    
    // Atualizar contador de feedbacks
    async function updateFeedbackCount() {
      try {
        if (!db) return;
        
        // Contar total de feedbacks no Firestore
        const snapshot = await db.collection('feedbacks').get();
        const totalFeedbacks = snapshot.size;
        
        // Atualizar o texto na interface usando o ID correto
        const feedbackCountElement = qs('#feedbackCount');
        if (feedbackCountElement) {
          feedbackCountElement.textContent = `${totalFeedbacks} avaliações`;
        }
        
        // Atualizar contador no painel admin
        const adminFeedbackCountElement = qs('#adminFeedbackCount');
        if (adminFeedbackCountElement) {
          adminFeedbackCountElement.textContent = totalFeedbacks;
        }
        
        
      } catch (error) {
        console.error('Erro ao atualizar contador de feedbacks:', error);
      }
    }

    // Zerar todos os feedbacks
    async function clearAllFeedbacks() {
      try {
        if (!db) {
          console.error('Firebase não inicializado');
          return;
        }

        // Confirmar ação
        if (!confirm('⚠️ ATENÇÃO: Esta ação irá APAGAR TODOS os feedbacks permanentemente!\n\nTem certeza que deseja continuar?')) {
          return;
        }

        console.log('🗑️ Iniciando limpeza de feedbacks...');
        
        // Buscar todos os feedbacks
        const snapshot = await db.collection('feedbacks').get();
        
        if (snapshot.empty) {
          console.log('Nenhum feedback encontrado para deletar');
          toast('Nenhum feedback encontrado');
          return;
        }

        // Deletar em lotes para evitar timeout
        const batch = db.batch();
        let deletedCount = 0;
        
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
          deletedCount++;
        });

        await batch.commit();
        
        // Limpar array local
        feedbacks.length = 0;
        
        // Atualizar interface
        renderFeedbacks();
        await updateFeedbackCount();
        
        console.log(`✅ ${deletedCount} feedbacks deletados com sucesso`);
        toast(`✅ ${deletedCount} feedbacks deletados com sucesso`);
        
      } catch (error) {
        console.error('❌ Erro ao deletar feedbacks:', error);
        toast('❌ Erro ao deletar feedbacks. Tente novamente.');
      }
    }

    // Atualizar feedbacks no painel admin
    async function refreshFeedbacks() {
      try {
        console.log('🔄 Atualizando feedbacks...');
        
        // Recarregar feedbacks do Firestore
        await loadFeedbacksFromFirestore();
        
        // Atualizar contador
        await updateFeedbackCount();
        
        toast('Feedbacks atualizados!');
        
      } catch (error) {
        console.error('❌ Erro ao atualizar feedbacks:', error);
        toast('❌ Erro ao atualizar feedbacks');
      }
    }
    init();


    // Função de teste para verificar API do Asaas
    window.testAsaas = async function() {
      try {
        console.log('🧪 Testando API do Asaas...');
        
        // Verificar se o serviço está disponível
        if (typeof asaasService === 'undefined') {
          console.error('❌ AsaasService não está disponível');
          return false;
        }
        
        console.log('✅ AsaasService disponível');
        
        // Verificar configuração
        const configValidation = validateConfig();
        console.log('🔍 Configuração:', configValidation);
        
        if (!configValidation.isValid) {
          console.error('❌ Configuração inválida:', configValidation.errors);
          return false;
        }
        
        console.log('✅ Configuração válida');
        
        // Testar conexão com a API do Asaas
        const testUrl = 'https://api.asaas.com/v3/customers';
        console.log('🌐 Testando conexão com:', testUrl);
        
        const response = await fetch(testUrl, {
          method: 'GET',
          headers: {
            'access_token': apiConfig.asaas.apiKey,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('📡 Status da resposta:', response.status);
        console.log('📡 Headers da resposta:', Object.fromEntries(response.headers.entries()));
        
        if (response.ok) {
          const data = await response.json();
          console.log('✅ API funcionando! Dados recebidos:', data);
          return true;
        } else {
          const errorText = await response.text();
          console.error('❌ Erro na API:', response.status, errorText);
          return false;
        }
        
      } catch (error) {
        console.error('❌ Erro no teste:', error);
        console.error('❌ Stack trace:', error.stack);
        return false;
      }
    };

    // Função para verificar CSP
    window.checkCSP = function() {
      console.log('🔒 Verificando Content Security Policy...');
      
      // Verificar se há meta tag CSP
      const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
      if (cspMeta) {
        console.log('✅ Meta tag CSP encontrada:', cspMeta.content);
      } else {
        console.log('❌ Meta tag CSP não encontrada');
      }
      
      // Verificar se há headers CSP no Netlify
      console.log('🌐 Para verificar headers do Netlify, use:');
      console.log('curl -I https://tfimports01.com.br');
      
      return true;
    };

    // Função para verificar todas as configurações
    window.checkAllConfigs = function() {
      console.log('🔍 Verificando todas as configurações...');
      
      // Verificar configuração da API
      const configValidation = validateConfig();
      console.log('📋 Configuração da API:', configValidation);
      
      // Verificar se os serviços estão disponíveis
      console.log('💳 AsaasService:', typeof asaasService !== 'undefined' ? '✅ Disponível' : '❌ Não disponível');
      console.log('🚚 SuperFreteService:', typeof superFreteService !== 'undefined' ? '✅ Disponível' : '❌ Não disponível');
      
      // Verificar configurações específicas
      console.log('💳 Asaas:', {
        apiKey: apiConfig.asaas.apiKey && apiConfig.asaas.apiKey !== 'SUA_API_KEY_AQUI' ? '✅ Configurada' : '❌ Não configurada',
        environment: apiConfig.asaas.environment,
        baseUrl: apiConfig.asaas.baseUrl
      });
      
      // Testar conectividade com Super Frete
      if (typeof superFreteService !== 'undefined') {
        superFreteService.testConnection().then(testResult => {
          console.log('🚚 Super Frete API:', testResult);
        });
      }
      
      console.log('🚚 Super Frete:', {
        apiKey: '✅ Configurada',
        baseUrl: 'https://api.superfrete.com',
        status: 'Ativo'
      });
      
      return true;
    };
  </script>

  <!-- Função global para voltar à loja -->
  <script>
    // Função específica para voltar à loja (deve estar no escopo global)
    function voltarParaLoja() {
      try {
        console.log('Voltando para a loja...');
        
        // Esconder painel atual
        const currentPanel = document.querySelector('.panel:not(.hidden)');
        if (currentPanel) {
          currentPanel.classList.add('hidden');
        }
        
        // Mostrar painel da loja
        const lojaPanel = document.getElementById('loja');
        if (lojaPanel) {
          lojaPanel.classList.remove('hidden');
        }
        
        // Atualizar hash
        window.location.hash = '#loja';
        
        // Atualizar navegação ativa
        qsa('[data-route]').forEach(a => a.classList.toggle('nav-active', a.getAttribute('href') === '#loja'));
        
        // Scroll para o topo
        window.scrollTo(0, 0);
        
        console.log('Navegação para loja concluída');
      } catch (error) {
        console.error('Erro ao voltar para loja:', error);
        // Fallback: usar navigate padrão
        if (typeof navigate === 'function') {
          navigate('#loja');
        } else {
          window.location.hash = '#loja';
        }
      }
    }

    // Funções para Modal de Confirmação
    function showConfirmacaoModal(orderData, paymentResult) {
      console.log('🔄 showConfirmacaoModal chamada com:', orderData, paymentResult);
      try {
        // Verificar se é um erro de pagamento
        const isPaymentError = orderData && orderData.success === false;
        const isCardDeclined = orderData && orderData.message && orderData.message.includes('Cartão de crédito recusado');
        
        console.log('💳 É erro de pagamento:', isPaymentError);
        console.log('💳 Cartão recusado:', isCardDeclined);
        // Preencher produtos
        const produtosContainer = qs('#confirmacaoProdutos');
        if (produtosContainer) {
          if (orderData.items && Array.isArray(orderData.items)) {
            produtosContainer.innerHTML = orderData.items.map(item => `
              <div class="flex justify-between items-center py-2 border-b border-slate-600 last:border-b-0">
                <div>
                  <div class="font-medium">${item.nome}</div>
                  <div class="text-xs text-slate-400">${item.cor} - ${item.tamanho} | Qtd: ${item.quantidade}</div>
                </div>
                <div class="font-bold">R$ ${(item.preco * item.quantidade).toFixed(2)}</div>
              </div>
            `).join('');
          } else if (orderData.orderData && orderData.orderData.items) {
            // Se orderData está aninhado (caso de erro)
            produtosContainer.innerHTML = orderData.orderData.items.map(item => `
              <div class="flex justify-between items-center py-2 border-b border-slate-600 last:border-b-0">
                <div>
                  <div class="font-medium">${item.nome}</div>
                  <div class="text-xs text-slate-400">${item.cor} - ${item.tamanho} | Qtd: ${item.quantidade}</div>
                </div>
                <div class="font-bold">R$ ${(item.preco * item.quantidade).toFixed(2)}</div>
              </div>
            `).join('');
          } else {
            // Fallback para erro de pagamento
            produtosContainer.innerHTML = '<div class="text-center text-slate-400 py-4">Erro ao carregar produtos</div>';
          }
        }

        // Preencher dados do cliente
        const clienteContainer = qs('#confirmacaoCliente');
        if (clienteContainer) {
          clienteContainer.innerHTML = `
            <div><strong>Nome:</strong> ${qs('#nome')?.value || 'N/A'}</div>
            <div><strong>Email:</strong> ${qs('#email')?.value || 'N/A'}</div>
            <div><strong>Telefone:</strong> ${qs('#telefone')?.value || 'N/A'}</div>
            <div><strong>CPF:</strong> ${qs('#cpf')?.value || 'N/A'}</div>
            <div><strong>Endereço:</strong> ${qs('#logradouro')?.value || 'N/A'}, ${qs('#numero')?.value || 'N/A'}</div>
            <div><strong>Cidade:</strong> ${qs('#cidade')?.value || 'N/A'} - ${qs('#uf')?.value || 'N/A'}</div>
            <div><strong>CEP:</strong> ${qs('#cep')?.value || 'N/A'}</div>
          `;
        }

        // Preencher frete
        const freteContainer = qs('#confirmacaoFrete');
        if (freteContainer) {
          const shipping = orderData.shipping || (orderData.orderData && orderData.orderData.shipping);
          if (shipping) {
            freteContainer.innerHTML = `
              <div><strong>Serviço:</strong> ${shipping.name}</div>
              <div><strong>Preço:</strong> R$ ${shipping.price.toFixed(2)}</div>
              <div><strong>Prazo:</strong> ${shipping.delivery_time} dias úteis</div>
            `;
          } else {
            freteContainer.innerHTML = '<div class="text-slate-400">Frete não disponível</div>';
          }
        }

        // Preencher total
        const totalContainer = qs('#confirmacaoTotal');
        if (totalContainer) {
          let total = 0;
          
          if (orderData.total) {
            total = orderData.total;
          } else if (orderData.items && Array.isArray(orderData.items)) {
            total = orderData.items.reduce((sum, item) => sum + (item.preco * item.quantidade), 0) + (orderData.shipping?.price || 0);
          } else if (orderData.orderData && orderData.orderData.items) {
            total = orderData.orderData.items.reduce((sum, item) => sum + (item.preco * item.quantidade), 0) + (orderData.orderData.shipping?.price || 0);
          }
          
          totalContainer.textContent = `R$ ${total.toFixed(2)}`;
        }

        // Preencher previsão de entrega
        const entregaContainer = qs('#confirmacaoEntrega');
        if (entregaContainer) {
          const shipping = orderData.shipping || (orderData.orderData && orderData.orderData.shipping);
          if (shipping) {
            const hoje = new Date();
            const prazoEntrega = new Date(hoje.getTime() + (parseInt(shipping.delivery_time) + 1) * 24 * 60 * 60 * 1000);
            const dataFormatada = prazoEntrega.toLocaleDateString('pt-BR');
            
            entregaContainer.innerHTML = `
              <div class="text-center">
                <div class="text-lg font-bold text-blue-400">${dataFormatada}</div>
                <div class="text-sm">${shipping.delivery_time} dias úteis após a postagem</div>
              </div>
            `;
          } else {
            entregaContainer.innerHTML = '<div class="text-center text-slate-400">Previsão não disponível</div>';
          }
        }

        // Mostrar modal
        const modal = qs('#confirmacaoModal');
        console.log('🔍 Modal encontrada:', modal);
        if (modal) {
          // Atualizar conteúdo do modal baseado no tipo (sucesso ou erro)
          const iconContainer = modal.querySelector('.w-16.h-16');
          const titleElement = modal.querySelector('h3');
          const subtitleElement = modal.querySelector('p');
          
          if (isPaymentError) {
            // Modal de erro
            if (iconContainer) {
              iconContainer.className = 'w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4';
              iconContainer.innerHTML = '<span class="text-2xl">❌</span>';
            }
            if (titleElement) {
              titleElement.className = 'text-2xl font-bold text-red-400 mb-2';
              titleElement.textContent = orderData.message || 'Erro no Pagamento';
            }
            if (subtitleElement) {
              subtitleElement.className = 'text-slate-300 mb-6';
              subtitleElement.textContent = orderData.details || 'Ocorreu um problema ao processar seu pagamento';
            }
          } else {
            // Modal de sucesso (padrão)
            if (iconContainer) {
              iconContainer.className = 'w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4';
              iconContainer.innerHTML = '<span class="text-2xl">✅</span>';
            }
            if (titleElement) {
              titleElement.className = 'text-2xl font-bold text-green-400 mb-2';
              titleElement.textContent = 'Compra Realizada!';
            }
            if (subtitleElement) {
              subtitleElement.className = 'text-slate-300 mb-6';
              subtitleElement.textContent = 'Seu pedido foi processado com sucesso';
            }
          }
          
          console.log('🔄 Removendo classe hidden e adicionando flex');
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          console.log('✅ Classes da modal atualizadas:', modal.className);
          
          // Forçar exibição com timeout para garantir que seja visível
          setTimeout(() => {
            if (modal.classList.contains('hidden')) {
              console.log('🔄 Forçando exibição da modal...');
              modal.classList.remove('hidden');
              modal.classList.add('flex');
            }
          }, 100);
        } else {
          console.error('❌ Modal #confirmacaoModal não encontrada!');
        }

        // Limpar carrinho após confirmação
        if (typeof state !== 'undefined') {
          state.carrinho = [];
          state.freteSelecionado = null;
          saveCart();
          updateCartCount();
        }

        console.log('✅ Modal de confirmação exibida com sucesso');

      } catch (error) {
        console.error('❌ Erro ao mostrar modal de confirmação:', error);
      }
    }

    function closeConfirmacaoModal() {
      const modal = qs('#confirmacaoModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    // Event listeners para modal de confirmação
    const btnFecharConfirmacao = qs('#btnFecharConfirmacao');
    if (btnFecharConfirmacao) {
      btnFecharConfirmacao.addEventListener('click', closeConfirmacaoModal);
    }

    const btnContinuarComprando = qs('#btnContinuarComprando');
    if (btnContinuarComprando) {
      btnContinuarComprando.addEventListener('click', () => {
        closeConfirmacaoModal();
        showPage('home');
      });
    }

    const btnVerPedidos = qs('#btnVerPedidos');
    if (btnVerPedidos) {
      btnVerPedidos.addEventListener('click', () => {
        closeConfirmacaoModal();
        showPage('perfil');
        // Recarregar pedidos quando navegar para o perfil
        setTimeout(() => {
          if (typeof loadUserOrders === 'function') {
            loadUserOrders();
          }
        }, 500);
      });
    }

    // Fechar modal clicando fora
    const confirmacaoModal = qs('#confirmacaoModal');
    if (confirmacaoModal) {
      confirmacaoModal.addEventListener('click', (e) => {
        if (e.target === confirmacaoModal) {
          closeConfirmacaoModal();
        }
      });
    }

    // ===== FUNCIONALIDADES DO INSTAGRAM =====
    
    // Posts do Instagram (serão carregados dinamicamente)
    let instagramPosts = [];
    let isLoadingPosts = false;
    
    // Posts reais do Instagram @tfimports01
    const fallbackPosts = [
      {
        id: 'DKVGOsdyquY',
        image: 'https://images.unsplash.com/photo-1551698618-1dfe5d97d256?w=400&h=400&fit=crop&crop=center&auto=format&q=80',
        caption: 'Novo lançamento TFI! 🔥 Coleção exclusiva disponível agora. #TFI #Moda #Lançamento',
        likes: 10,
        comments: 3,
        permalink: 'https://www.instagram.com/p/DKVGOsdyquY/'
      },
      {
        id: 'DJ4aGYiNR55',
        image: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=400&h=400&fit=crop&crop=center&auto=format&q=80',
        caption: 'Making of da produção 📸 Por trás das câmeras da TFI. Qualidade e estilo em cada detalhe! #TFI #MakingOf #Produção',
        likes: 11,
        comments: 5,
        permalink: 'https://www.instagram.com/p/DJ4aGYiNR55/'
      },
      {
        id: 'DJ19O8itDRZ',
        image: 'https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=400&h=400&fit=crop&crop=center&auto=format&q=80',
        caption: 'Oferta especial! 💥 Desconto exclusivo para seguidores. Não perca! #TFI #Oferta #Desconto',
        likes: 14,
        comments: 7,
        permalink: 'https://www.instagram.com/p/DJ19O8itDRZ/'
      }
    ];

    // Carregar posts do Instagram (usando dados reais configurados)
    function loadRealInstagramPosts() {
      
      // Usar posts reais configurados diretamente
      instagramPosts = [...fallbackPosts];
      renderInstagramPosts();
    }


    // Renderizar posts do Instagram
    function renderInstagramPosts() {
      const container = qs('#instagramPosts');
      if (!container) {
        console.error('❌ Container #instagramPosts não encontrado');
        return;
      }


      if (instagramPosts.length === 0) {
        container.innerHTML = `
          <div class="col-span-3 flex items-center justify-center py-8">
            <div class="text-center text-slate-400">
              <div class="text-2xl mb-2">📸</div>
              <div class="text-sm">Nenhum post encontrado</div>
            </div>
          </div>
        `;
        return;
      }

      container.innerHTML = instagramPosts.map(post => `
        <div class="instagram-post relative group cursor-pointer" data-post-id="${post.id}">
          <div class="card-img rounded-xl h-24 bg-cover bg-center relative overflow-hidden bg-slate-700" 
               style="background-image: url('${post.image}')">
            <img src="${post.image}" 
                 alt="Post do Instagram" 
                 class="w-full h-full object-cover"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                 style="display: block;">
            <div class="absolute inset-0 bg-slate-700 flex items-center justify-center" style="display: none;">
              <div class="text-center text-slate-400">
                <div class="text-2xl mb-1">📸</div>
                <div class="text-xs">Imagem não disponível</div>
              </div>
            </div>
            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
              <div class="text-center text-white">
                <div class="text-lg">❤️ ${post.likes}</div>
                <div class="text-sm">💬 ${post.comments}</div>
              </div>
            </div>
          </div>
          <div class="mt-1 text-xs text-slate-400 truncate">${post.caption}</div>
        </div>
      `).join('');

      // Adicionar event listeners para os posts
      container.querySelectorAll('.instagram-post').forEach(post => {
        post.addEventListener('click', () => {
          const postId = post.dataset.postId;
          const postData = instagramPosts.find(p => p.id == postId);
          if (postData) {
            showInstagramPostModal(postData);
          }
        });
      });

    }

    // Mostrar modal com detalhes do post
    function showInstagramPostModal(post) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-slate-800 rounded-2xl max-w-md w-full p-6 relative">
          <button class="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl" onclick="this.closest('.fixed').remove()">×</button>
          <div class="mb-4">
            <div class="card-img rounded-xl h-64 bg-cover bg-center mb-3 bg-slate-700 relative overflow-hidden" 
                 style="background-image: url('${post.image}')">
              <img src="${post.image}" 
                   alt="Post do Instagram" 
                   class="w-full h-full object-cover"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                   style="display: block;">
              <div class="absolute inset-0 bg-slate-700 flex items-center justify-center" style="display: none;">
                <div class="text-center text-slate-400">
                  <div class="text-4xl mb-2">📸</div>
                  <div class="text-sm">Imagem não disponível</div>
                </div>
              </div>
            </div>
            <h3 class="font-bold text-lg mb-2">@tfimports01</h3>
            <p class="text-slate-300 mb-3">${post.caption}</p>
            <div class="flex items-center gap-4 text-sm text-slate-400">
              <span>❤️ ${post.likes} curtidas</span>
              <span>💬 ${post.comments} comentários</span>
            </div>
          </div>
          <div class="flex gap-3">
            <a href="${post.permalink || 'https://www.instagram.com/tfimports01/'}" target="_blank" 
               class="btn cta-gradient px-4 py-2 rounded-lg font-bold flex-1 text-center">
              Ver no Instagram
            </a>
            <button onclick="this.closest('.fixed').remove()" 
                    class="btn px-4 py-2 rounded-lg pill">
              Fechar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Fechar modal clicando fora
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // Atualizar posts do Instagram
    function refreshInstagramPosts() {
      console.log('🔄 Atualizando posts do Instagram...');
      loadRealInstagramPosts();
      
      // Mostrar notificação de sucesso
      if (typeof toast === 'function') {
        toast('Posts do Instagram atualizados!');
      } else {
        console.log('✅ Posts do Instagram atualizados!');
      }
    }

    // Event listener para o botão de atualizar
    document.addEventListener('DOMContentLoaded', () => {
      
      const btnRefresh = qs('#btnRefreshInstagram');
      if (btnRefresh) {
        btnRefresh.addEventListener('click', refreshInstagramPosts);
      } else {
        console.error('❌ Botão de atualizar não encontrado');
      }
      
      // Carregar posts reais na inicialização
      loadRealInstagramPosts();
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9721b30b149bf202',t:'MTc1NTY5MDkwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
